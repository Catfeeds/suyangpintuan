<?php #支付接口函数库/** * 取得返回信息地址 * @param   string  $code   支付方式代码 */function return_url($code) {    return RootUrl . 'welcome/respond?code=' . $code;}/** *  取得某支付方式信息 *  @param  string  $code   支付方式代码 */function get_payment($code) {    global $lowxp;    $sql     = "SELECT * FROM ###_payment WHERE pay_code = '$code' AND enabled = '1' LIMIT 1";    $payment = $lowxp->db->get($sql);    if ($payment) {        $config_list = unserialize($payment['pay_config']);        foreach ($config_list AS $config) {            $payment[$config['name']] = $config['value'];        }    }    return $payment;}/** *  通过订单sn取得订单ID *  @param  string  $order_sn   订单sn *  @param  blob    $voucher    是否为会员充值 */function get_order_id_by_sn($order_sn, $voucher = 'false') {    global $lowxp;    if ($voucher == 'true') {        if ($order_sn) {            $lowxp->db->getstr("SELECT log_id FROM ###_pay_log WHERE order_id=" . $order_sn . ' AND order_type=' . PAY_SURPLUS);        } else {return "";}    } else {        $order_id = '';        if ($order_sn) {            $order_id = $lowxp->db->getstr("SELECT id FROM ###_goods_order WHERE order_sn = '$order_sn'");        }        if (!empty($order_id)) {            $pay_log_id = $lowxp->db->getstr("SELECT log_id FROM ###_pay_log WHERE order_id='" . $order_id . "'");            return $pay_log_id;        } else {return "";}    }}/** *  通过订单ID取得订单商品名称 *  @param  string  $order_id   订单ID */function get_goods_name_by_id($order_id) {    global $lowxp;    $sql        = "SELECT goods_name FROM ###_goods_order_item WHERE order_id = '" . $order_id . "'";    $res        = $lowxp->db->select($sql);    $goods_name = '';    foreach ($res as $v) {        $goods_name .= ',' . $v['goods_name'];    }    return substr($goods_name, 1);}/** * 检查支付的金额是否与订单相符 * * @access  public * @param   string   $log_id      支付编号 * @param   float    $money       支付接口返回的金额 * @return  true */function check_money($log_id, $money) {    global $lowxp;    $sql    = "SELECT order_amount FROM ###_pay_log WHERE log_id = '" . $log_id . "'";    $amount = $lowxp->db->getstr($sql);    if ($money == $amount) {return true;} else {return false;}}/** * 支付订单状态 */function order_paid($log_id, $pay_status = PS_PAYED, $note = '',$trade_no='') {    global $lowxp;    /* 取得支付编号 */    $log_id = intval($log_id);    if ($log_id > 0) {        $lowxp->load->model('payment');        /* 取得要修改的支付记录信息 */        $pay_log = $lowxp->payment->pay_log($log_id);        if ($pay_log && $pay_log['is_paid'] == 0) {            /* 修改此次支付操作的状态为已付款 */            $lowxp->payment->pay_log_save(array('log_id' => $log_id, 'is_paid' => 1,'trade_no'=>$trade_no));            /* 根据记录类型做相应处理 */            if ($pay_log['order_type'] == PAY_ORDER || $pay_log['order_type'] == PAY_END) {                #订单状态设为：已付款                $lowxp->load->model('order');                $lowxp->order->chageOrderState($pay_log['order_id'], array('status_pay' => 10,'pay_time'=>RUN_TIME), '订单支付成功', array('amount' => $pay_log['order_amount']));                //余额红包积分等处理                $lowxp->load->model('order');                $order = $lowxp->db->get("SELECT * FROM ###_goods_order WHERE id=" . $pay_log['order_id']);                $lowxp->order->moneyOrder($order);            } elseif ($pay_log['order_type'] == PAY_SURPLUS) {                $lowxp->load->model('member');                $lowxp->db->update('member_account', array('status' => 2), array('id' => $pay_log['order_id']));                $member_account           = $lowxp->db->get("SELECT * FROM ###_member_account WHERE id = '" . $pay_log['order_id'] . "'");                $insert_arr               = array();                $insert_arr['mid']        = $member_account['mid'];                $insert_arr['user_money'] = $member_account['amount'];                $insert_arr['desc']       = "通过$member_account[pay_name]充值账户";                $lowxp->member->accountlog('recharge', $insert_arr);                $url = url('/member/accountlog');            }elseif ($pay_log['order_type'] == PAY_BS) {//商家认证费和保证金                $lowxp->db->update("business",array("pay_status"=>1),array('id'=>$pay_log['order_id']));				$business = $lowxp->db->get("SELECT `name`,`deposit` FROM ###_business WHERE id = '" . $pay_log['order_id'] . "'");                //这里插入保证金记录                $account_insert = array();                $account_insert['bid'] = $pay_log['order_id'];                $account_insert['name'] = $business['name'];                $account_insert['deposit'] = $business['deposit'];                $account_insert['logtime'] = RUN_TIME;                $lowxp->db->insert("business_account",$account_insert);            }elseif($pay_log['order_type'] == PAY_PRE) {//阶梯团支付定金                #订单状态设为：已付款                $lowxp->load->model('order');                $lowxp->order->chageOrderState($pay_log['order_id'], array('status_pay' => 1,'pay_time'=>RUN_TIME), '定金支付成功', array('amount' => $pay_log['order_amount']));            }        }    }}/** * 支付宝批量退款处理 */function alipay_refund($result_details){    global $lowxp;    $result_array = explode("#",$result_details);    $lowxp->load->model("refund");    if(is_array($result_array)){        foreach($result_array as $v){            $temp = explode("^",$v);            $refund = $lowxp->db->get("select * from ###_refund_log where trade_no = '{$temp[0]}'");            if($temp[2]=="SUCCESS"){                if($refund['is_refund']==3){                    $res = $lowxp->refund->updateRefundLog($refund['id'], array( "is_refund" => 1, "order_id" => $refund['order_id']));                }            }else{                $res = $lowxp->refund->updateRefundLog($refund['id'], array( "is_refund" => 2,"remark"=>$temp[2], "order_id" => $refund['order_id']));            }        }    }    return $res['code']==0?true:false;}?>