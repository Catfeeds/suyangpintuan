<?php/** * ZZCMS 专题管理 * ============================================================================ * * 版权所有 2014-2016 厦门紫竹数码科技有限公司，并保留所有权利。 * 网站地址: http://www.lnest.com； * ---------------------------------------------------------------------------- * 这不是一个自由软件！您只能在不用于商业目的的前提下对程序代码进行修改和 * 使用；不允许对程序代码以任何形式任何目的的再发布。 */class topic extends Lowxp{    function __construct()    {        parent::__construct();        $this->load->model("topic");        $this->load->model("topic_type");    }    /*    * 专题活动    */    function index($type=1,$typeid=0,$page = 1)    {        ${$_REQUEST['k']} = $_REQUEST['q'];        $apply_time = !empty($_GET['apply_time']) ? strtotime($_GET['apply_time']) : 0;        $act_time = !empty($_GET['act_time']) ? strtotime($_GET['act_time']) : 0;        if ($id > 0) {            $where .= " AND id=" . $id;        }        if ($name) {            $where .= " AND name like '%".$name."%'";        }        if($type>0){            $where .= " AND type=" .$type;        }        if($typeid>0){            $where .= " AND typeid=" .$typeid;        }        if ($apply_time > 0) {            $where .= " AND apply_stime<=" . $apply_time." AND apply_etime>=".$apply_time;        }        if ($act_time > 0) {            $where .= " AND start_time<=" . $act_time." AND end_time>=".$act_time;        }        $sort = !empty($_GET['sort']) ? trim($_GET['sort']) : 'id';        $order = !empty($_GET['sort']) ? trim($_GET['order']) : 'DESC';        $option['page'] = $page;        $option['where'] = $where;        $option['order'] = " ORDER BY $sort $order ";        $option['type'] = $type;        $option['typeid'] = $typeid;        $list = $this->topic->getTopicList($option);        $topictype = $this->topic_type->getTypeList($type);        foreach($list as $k=>$v){            $list[$k]['type_name'] = $topictype[$v['typeid']];            $list[$k]['count'] = $this->db->getstr("select count(1) as num from ###_topic_goods  where act_id={$v['id']}","num");        }        $this->smarty->assign('list', $list);        $this->smarty->assign('topictype', $topictype);        foreach($topictype as $k=>$v){            $this->btnMenu[$k] = array('url'=>'#!topic/index/'.$type.'/'.$k,'name'=>$v);        }        $this->smarty->assign('btnMenu', $this->btnMenu);        $this->smarty->assign('btnNo', $typeid);        $this->smarty->assign('type', $type);        $this->smarty->assign('typeid', $typeid);        $this->smarty->display('business/topic/list.html');    }    /*    * 报名专题活动    */    function apply($type=0){        if (isset($_POST['Submit'])) {            $_POST['post']['sid'] = BID;            $post = $_POST['post'];            $array    = $this->base->explodeChar($post['goods_id'], "\n");            foreach ($array as $v) {                if (trim($v)) {                    $post['goods_id'] = $v;                    $is_res = $this->db->get("select 1 from ###_goods where id={$post['goods_id']} and sid=".BID);                    if(!$is_res){                        $res['message'] = '商品id不存在';                        continue;                    }                    $res = $this->topic->apply_save($post);                }            }            if (isset($res['code']) && $res['code'] == 0) {                $this->tip($res['message'], array('inIframe' => true));                $this->exeJs("parent.com.xhide();parent.main.refresh()");            } else {                $this->tip($res['message'], array('inIframe' => true, 'type' => 1));            }            exit;        }        $id = $_GET['id'];        $row = $this->topic->getTopicOne($id);        $this->smarty->assign('row', $row);        if($row['catid']){            $this->load->model("topiccat");            $select_categorys = $this->topiccat->get_option(0,$row['catid']);            $this->smarty->assign('select_categorys', $select_categorys);        }        $topictype = $this->topic_type->getTypeList($type);        $this->smarty->assign('topictype', $topictype);        $this->smarty->display('business/topic/apply.html');    }    /*    * 报名列表    */    function apply_list($page=1){        ${$_REQUEST['k']} = $_REQUEST['q'];        $start_time = !empty($_GET['start_time']) ? strtotime($_GET['start_time']) : 0;        $end_time = !empty($_GET['end_time']) ? strtotime($_GET['end_time']) : 0;        $type = !empty($_GET['typeid']) ? intval($_GET['typeid']) : 0;        $where = " AND sid=" . BID;        if ($id > 0) {            $where .= " AND id=" . $id;        }        if($type>0){            $w_res = $this->db->select("select id from ###_topic where typeid={$type}");            if($w_res){                $ids_tem = array_column($w_res,"id");                $where.= " AND act_id in (".join(',',$ids_tem).")";            }else{                $where.= " AND 1=2 ";            }        }        if(!empty($_GET['status']) || $_GET['status']=='0'){            $where .=" AND status=".intval($_GET['status']);        }        if ($start_time > 0) {            $where .= " AND start_time>=" . $start_time;        }        if ($end_time > 0) {            $where .= " AND end_time<=" . $end_time;        }        $sort = !empty($_GET['sort']) ? trim($_GET['sort']) : 'id';        $order = !empty($_GET['sort']) ? trim($_GET['order']) : 'DESC';        $option['page'] = $page;        $option['where'] = $where;        $option['order'] = " ORDER BY $sort $order ";        $list = $this->topic->getApplyList($option);        $list = $this->db->lJoin($list,"topic","id,name,start_time,end_time,typeid","act_id","id","act_");        $list = $this->db->lJoin($list,"goods","id,name,team_price,thumb","goods_id","id","goods_");        $topictype = $this->topic_type->getTypeList();        foreach($list as $k=>$v){            $thumb = json_decode($v['goods_thumb'],true);            $list[$k]['img_src'] = yunurl($thumb[0]['path']);            $list[$k]['type_name'] = $topictype[$v['act_typeid']];        }        $this->smarty->assign('list', $list);        $this->smarty->assign('topictype', $topictype);        $this->smarty->assign('btnNo', $type);        $this->smarty->display('business/topic/apply_list.html');    }    //更新    function edit()    {        //提交        if (isset($_POST['Submit'])) {            $res = $this->topic->save();            if (isset($res['code']) && $res['code'] == 0) {                $this->tip($res['message'], array('inIframe' => true));                $this->exeJs("parent.com.xhide();parent.main.refresh()");            } else {                $this->tip($res['message'], array('inIframe' => true, 'type' => 1));            }            exit;        }        $id = (int)$_GET['id'];        $row = $this->topic->getTopicOne($id);        //生成图片控件        $row['thumb'] = isset($row['thumb']) ? $row['thumb'] : '';        $row['thumbs'] = isset($row['thumbs']) ? $row['thumbs'] : '';        $row['html_thumb'] = $this->form->files('thumb', $row['thumb']);        $row['html_thumbs'] = $this->form->files('thumbs', $row['thumbs'], '上传图集', array(            'maxnum' => 5,        ));        $topictype = $this->topic->topicType;        $this->smarty->assign('topictype', $topictype);        $this->smarty->assign('row', $row);        $this->smarty->display('business/topic/edit.html');    }}