<?php/** * 砍价 * 这不是一个自由软件！您只能在不用于商业目的的前提下对程序代码进行修改和 * 使用；不允许对程序代码以任何形式任何目的的再发布。 */class bargain extends Lowxp {	function __construct() {        $this->btnMenu = array(            0 => array('url' => '#!bargain/index', 'name' => '砍价活动'),            1 => array('url' => '#!bargain/log_list', 'name' => '砍价记录列表'),            2 => array('url' => '#!bargain/edit', 'name' => '添加砍价'),        );        parent::__construct();        $this->load->model("bargain");        if($this->bargain->pow==0){            $this->tip('请先安装砍价插件', array('inIframe' => true));            die;        }	}    //砍价活动	function index($page = 1) {	    $option = array("page"=>$page);	    ${$_REQUEST['k']} = trim($_REQUEST['q']);        $option['where'] = " and sid=".BID;	    if($goods_id){	        $option['where'] = " and goods_id={$goods_id} ";        }        if($goods_name){	        $res = $this->db->select("select id from ###_goods where name like '%{$goods_name}%' ");	        if($res){	            $ids = join(",",array_column($res,"id"));                $option['where'] .=" and goods_id in ({$ids}) ";            }else{	            $option['where'] .=" and 1=2 ";            }        }        if($_REQUEST['status']>0){            $status = $_REQUEST['status']==1?1:0;            $option['where'] .= " and status={$status} ";        }        if($_REQUEST['is_check']>0 || $_REQUEST['is_check']=='0'){            $option['where'] .= " and is_check={$_REQUEST['is_check']} ";        }	    $list = $this->bargain->getList($option);		$this->smarty->assign('list', $list);		$this->smarty->assign('btnNo', 0);		$this->smarty->display('business/bargain/list.html');	}	//更新	function edit() {	    $num  = $this->db->getstr("select count(1) as num from ###_bargain where sid=".BID,"num");        $num = C('bargain_sid_num')-$num;        $num = $num<=0?0:$num;		//提交		if (isset($_POST['Submit'])) {		    if($num==0 && empty($_POST['post']['id'])){                $this->tip("活动数量已经达到最大限制", array('inIframe' => true));                die;            }            $post = $_POST['post'];            $post['sid'] = BID;            $post['is_check'] = 0;            $post['status'] = 0;            $res = $this->bargain->save($post);            if ($res['code']==0) {                $this->tip($res['message'], array('inIframe' => true));                $this->exeJs("parent.window.location='/business#!bargain/index';");            } else {                $this->tip($res['message'], array('inIframe' => true, 'type' => 1));            }            exit;		}		$id = (int) $_GET['id'];		$row = $this->bargain->getOne($id);        $html_note = $this->form->editor('note', $row['note'], 'name="post[note]" style="width:100%;height:240px;"');        $this->smarty->assign('html_note', $html_note);		$this->smarty->assign('row', $row);		$this->smarty->assign('num', $num);        $this->smarty->assign('btnNo', 2);		$this->smarty->display('business/bargain/edit.html');	}    //砍价记录列表    function log_list($page = 1){        $option = array("page"=>$page);        ${$_REQUEST['k']} = trim($_REQUEST['q']);        $option['where'] = " and sid=".BID;        if($goods_id){            $option['where'] = " and goods_id={$goods_id} ";        }        if($goods_name){            $res = $this->db->select("select id from ###_goods where name like '%{$goods_name}%' ");            if($res){                $ids = join(",",array_column($res,"id"));                $option['where'] .=" and goods_id in ({$ids}) ";            }else{                $option['where'] .=" and 1=2 ";            }        }        if($_REQUEST['order_id']){            $option['where'] = " and order_id={$_REQUEST['order_id']} ";        }        if($_REQUEST['status'] || $_REQUEST['status']=='0'){            $option['where'] = " and status={$_REQUEST['status']} ";        }        if(trim($_REQUEST['username'])){            $res_mid = $this->db->select("select mid from ###_member where username like '%".trim($_REQUEST['username'])."%'");            if($res_mid){                $ids = join(",",array_column($res_mid,"mid"));                $option['where'] .=" and mid in ({$ids}) ";            }else{                $option['where'] .=" and 1=2 ";            }        }        $list = $this->bargain->getLogList($option);        $this->smarty->assign('list', $list);        $this->smarty->assign('btnNo', 1);        $this->smarty->display('manage/bargain/log_list.html');    }    //帮忙砍价记录列表    function help_log_list(){        $log_id = $_REQUEST['log_id'];        $row = $this->bargain->getLogOne($log_id);        $list = $this->bargain->getHelpLogList($log_id);        $this->smarty->assign('row', $row);        $this->smarty->assign('list', $list);        $this->smarty->assign('btnNo', 1);        $this->smarty->display('manage/bargain/help_log_list.html');    }    //删除砍价    function del(){        $id = $_REQUEST['id'];        $has_res = $this->db->getstr("select 1 from ###_bargain_log where bargain_id={$id} and sid=".BID);        if($has_res){            $this->tip('该活动已有人参加不能删除', array('inIframe' => true));            die;        }        $this->db->delete("bargain",array("id"=>$id));    }}