<?php/** * 助力 * 这不是一个自由软件！您只能在不用于商业目的的前提下对程序代码进行修改和 * 使用；不允许对程序代码以任何形式任何目的的再发布。 */class assist extends Lowxp {	function __construct() {        $this->btnMenu = array(            0 => array('url' => '#!assist/index', 'name' => '助力活动'),            1 => array('url' => '#!assist/log_list', 'name' => '助力记录列表'),            2 => array('url' => '#!assist/edit', 'name' => '添加助力'),        );        parent::__construct();        $this->load->model("assist");        if($this->assist->power==0){            $this->tip('请先安装助力插件', array('inIframe' => true));            die;        }	}    //助力活动	function index($page = 1) {	    $option = array("page"=>$page);	    ${$_REQUEST['k']} = trim($_REQUEST['q']);        $option['where'] = " and sid=".BID;	    if($goods_id){	        $option['where'] = " and goods_id={$goods_id} ";        }        if($goods_name){	        $res = $this->db->select("select id from ###_goods where name like '%{$goods_name}%' ");	        if($res){	            $ids = join(",",array_column($res,"id"));                $option['where'] .=" and goods_id in ({$ids}) ";            }else{	            $option['where'] .=" and 1=2 ";            }        }        if($_REQUEST['status']>0){            $status = $_REQUEST['status']==1?1:0;            $option['where'] .= " and status={$status} ";        }        if($_REQUEST['is_check']>0 || $_REQUEST['is_check']=='0'){            $option['where'] .= " and is_check={$_REQUEST['is_check']} ";        }        if($_REQUEST['sid']>0){            $option['where'] .= " and sid={$_REQUEST['sid']} ";        }        //商家        if ($_REQUEST['bname']) {            $bid_array = $this->db->select("select id from ###_business where name LIKE '%" . addslashes($_REQUEST['bname']) . "%'");            if($bid_array){                $bid_array = array_column($bid_array,"id");                $option['where'] .= " AND sid in (".join(',',$bid_array).") ";            }else{                $option['where'] .= " AND 1=2 ";            }        }	    $list = $this->assist->getList($option);        $list = $this->db->lJoin($list,"business","id,name","sid","id","b_");        //商家列表        $res_business = $this->db->select("select id,name from ###_business where status=1");        if(count($res_business)>0){            $business = array_combine(array_column($res_business, 'id'), array_column($res_business, "name"));        }else{            $business = array();        }		$this->smarty->assign('list', $list);		$this->smarty->assign('is_more', in_array(Edition,array("enter_more","more")));		$this->smarty->assign('business_list',$business);		$this->smarty->assign('btnNo', 0);		$this->smarty->display('business/assist/list.html');	}	//更新	function edit() {		//提交		if (isset($_POST['Submit'])) {		    $post = $_POST['post'];            $post['sid'] = BID;            $post['is_check'] = 0;            $post['status'] = 0;            $res = $this->assist->save($post);			if ($res['code']==0) {				$this->tip($res['message'], array('inIframe' => true));                $this->exeJs("parent.window.location='/business#!assist/index';");			} else {				$this->tip($res['message'], array('inIframe' => true, 'type' => 1));			}			exit;		}		$id = (int) $_GET['id'];		$row = $this->assist->getOne($id);        $html_note = $this->form->editor('note', $row['note'], 'name="post[note]" style="width:100%;height:240px;"');        $this->smarty->assign('html_note', $html_note);		$this->smarty->assign('row', $row);        $this->smarty->assign('is_more', in_array(Edition,array("enter_more","more")));        $this->smarty->assign('btnNo', 2);		$this->smarty->display('business/assist/edit.html');	}    //助力记录列表    function log_list($page = 1){        $option = array("page"=>$page);        ${$_REQUEST['k']} = trim($_REQUEST['q']);        $option['where'] = " and sid=".BID;        if($goods_id){            $option['where'] = " and goods_id={$goods_id} ";        }        if($goods_name){            $res = $this->db->select("select id from ###_goods where name like '%{$goods_name}%' ");            if($res){                $ids = join(",",array_column($res,"id"));                $option['where'] .=" and goods_id in ({$ids}) ";            }else{                $option['where'] .=" and 1=2 ";            }        }        if($_REQUEST['order_id']){            $option['where'] = " and order_id={$_REQUEST['order_id']} ";        }        if($_REQUEST['status'] || $_REQUEST['status']=='0'){            $option['where'] = " and status={$_REQUEST['status']} ";        }        if(trim($_REQUEST['username'])){            $res_mid = $this->db->select("select mid from ###_member where username like '%".trim($_REQUEST['username'])."%'");            if($res_mid){                $ids = join(",",array_column($res_mid,"mid"));                $option['where'] .=" and mid in ({$ids}) ";            }else{                $option['where'] .=" and 1=2 ";            }        }        $list = $this->assist->getLogList($option);        $this->smarty->assign('list', $list);        $this->smarty->assign('btnNo', 1);        $this->smarty->display('business/assist/log_list.html');    }    //帮忙助力记录列表    function help_log_list(){        $log_id = $_REQUEST['log_id'];        $row = $this->assist->getLogOne($log_id);        $list = $this->assist->getHelpLogList($log_id);        $this->smarty->assign('row', $row);        $this->smarty->assign('list', $list);        $this->smarty->assign('btnNo', 1);        $this->smarty->display('business/assist/help_log_list.html');    }    //删除助力    function del(){        $id = $_REQUEST['id'];        $has_res = $this->db->getstr("select 1 from ###_assist_log where assist_id={$id} and sid=".BID);        if($has_res){            $this->tip('该活动已有人参加不能删除', array('inIframe' => true));            die;        }        $this->db->delete("assist",array("id"=>$id));    }}