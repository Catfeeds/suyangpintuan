<?php/** * ZZCMS 模型内容页 * ============================================================================ * * 版权所有 2014-2016 厦门紫竹数码科技有限公司，并保留所有权利。 * 网站地址: http://www.lnest.com； * ---------------------------------------------------------------------------- * 这不是一个自由软件！您只能在不用于商业目的的前提下对程序代码进行修改和 * 使用；不允许对程序代码以任何形式任何目的的再发布。 */class content extends Lowxp {	function __construct() {		parent::__construct();		$this->load->model('content');		$this->load->model('category');		$this->load->model('form_field');                        //获取商家信息        $this->business_info = '';        if(isset($_SESSION['b_id'])){            $this->load->model("business");            $this->business_info = $this->business->get($_SESSION['b_id']);            $this->business_info['amount'] = $this->business_info['fee']+$this->business_info['deposit'];        }	}	/* #封面或列表页		     * $data.cat 当前栏目信息		     * $data.row 当前栏目信息 主要用于display_before seo信息提取		     * $data.page 单页内容信息		     * $data.catlist 所有父类ID	*/	function index($catid, $page = 1) {        $data['b_info'] = $this->business_info;		#栏目信息		if (!is_numeric($catid)) {			$m = $catid;		} else {			$data['row'] = $data['cat'] = $this->category->get($catid);			if (!$data['cat']) {showError('访问错误，栏目不存在');die;}			$m = $data['cat']['module'];		}		$this->chkModule($m);		$where = ' WHERE lang=' . LANG_ID;		#提交表单		if (isset($_POST['Submit'])) {			#在线留言同IP一天只能留言一次			if ($m == 'gbook') {				//$this->exeJs("parent.layer.msg('抱歉，暂不开放留言功能！');");die;				$_POST['post']['ip'] = getIP();				$sql                 = "SELECT ip FROM ###_gbook WHERE createtime>'" . strtotime('-1 days') . "' AND `ip`='" . getIP() . "'";				if ($this->db->get($sql)) {					$this->exeJs("parent.layer.msg('24小时内您已留言，请明天再试哦！')");die;				}				$_POST['post']['name']    = trim($_POST['post']['name']);				$_POST['post']['email']   = trim($_POST['post']['email']);				$_POST['post']['content'] = trim($_POST['post']['content']);				if ($_POST['post']['content'] == '您希望上架的产品链接' || $_POST['post']['name'] == '您的姓名或昵称' || $_POST['post']['email'] == '您的联系方式') {					$this->exeJs("parent.layer.msg('表单填写不完整！');");die;				}				//有html标签提示				if ($_POST['post']['content'] != strip_tags($_POST['post']['content']) || $_POST['post']['name'] != strip_tags($_POST['post']['name']) || $_POST['post']['email'] != strip_tags($_POST['post']['email'])) {					$this->exeJs("parent.layer.msg('表单内容不合法，请清除HTML标签！');");die;				}				$_POST['post']['name']    = $this->base->safe_replace($_POST['post']['name']);				$_POST['post']['email']   = $this->base->safe_replace($_POST['post']['email']);				$_POST['post']['content'] = $this->base->safe_replace($_POST['post']['content']);				$res = $this->content->save();			}			if (isset($res['code']) && $res['code'] == 0) {				$this->exeJs("parent.layer.msg('留言成功',2,{type:1});");				$this->refresh(0, true);			} else {				$this->exeJs("parent.layer.msg('" . $res['message'] . "')");			}			exit;		}		#所有父类ID		$data['catlist'] = $this->category->parentArr($catid);        if($data['catlist'][1]){            $data['ban_thumb'] = $this->db->getstr("select thumb from ###_category where id={$data['catlist'][1]}","thumb");        }		#单页		if ($m == 'page') {			$where .= " AND id=" . $catid;			$data['page'] = $this->db->get("SELECT * FROM ###_" . $m . $where);			#更新点击			if ($this->fieldsinfo['hits']) {				$this->db->update($m, 'hits=hits+1', array('id' => $catid));			}		}		#模型列表		else {			#内容列表条件			if ($this->fieldsinfo['status']) {				$where .= " AND `status`=1";			}			if ($catid && !empty($this->fieldsinfo['catid'])) {				$where .= " AND `catid`" . $this->category->condArrchild($catid);			}			#筛选			if ($_GET['act'] == 'search') {				$listsearch = array('title', 'decription', 'content', 'catid');				$conds      = $this->content->getConds($listsearch);				$where .= count($conds) ? ' AND ' . implode(' AND ', $conds) : '';			}			#内容列表字段			$fields = $this->moduleinfo['listfields'];			$fields = empty($fields) ? '*' : $fields;			#分页			$this->load->model('page');			$_GET['page'] = intval($page);			$pagesize     = $data['cat']['pagesize'] ? (int) $data['cat']['pagesize'] : (int) $this->site_config['page_size'];			$this->page->set_vars(array('per' => $pagesize));			#内容列表结果			$sql          = "SELECT * FROM ###_" . $m . $where . " ORDER BY listorder DESC,id DESC";			$data['list'] = $this->page->hashQuery($sql, $catid . '/')->result_array();		}		#发送变量		$this->smarty->assign('fieldsinfo', $this->fieldsinfo);		$this->smarty->assign('data', $data);		$this->display_before($data['row']);		#显示模板		$template = 'list';		if ($data['row']['listtype'] == 2) {			$template = 'form';		}		if ($data['row']['listtype'] == 1 || $m == 'page') {			$template = 'index';		}		if ($data['row']['listtype'] == 0) {			$template = 'list';		}		$template = !empty($data['row']['template_list']) ? $data['row']['template_list'] : $template;		#异步加载		if (isset($_GET['load'])) {			$template_load = !empty($_GET['load']) ? trim($_GET['load']) : $m . '_' . $template;            $content = '';			if ($data['list']) {				foreach ($data['list'] as $v) {					$this->smarty->assign('m', $v);					$content .= $this->smarty->fetch('lbi/' . $template_load . '.html');				}			}            echo $content;die;		}		$this->smarty->assign('page_data_id', isset($catid) ? $catid : 0);		$tpl = $m . '_' . $template . '.html';		$this->smarty->display($tpl);	}	/* #详情页		     * $data.cat 所属栏目信息		     * $data.row 内容信息		     * $data.catlist 所有父类ID	*/	function show($catid, $id) {        $data['b_info'] = $this->business_info;		#栏目信息		$data['cat'] = $this->category->get($catid);		if (!$data['cat']) {showError('访问错误，栏目不存在');die;}		if (empty($id)) {showError('内容不存在');die;}		$m = $data['cat']['module'];		$this->chkModule($m);		#所有父类ID		$data['catlist'] = $this->category->parentArr($catid);        if($data['catlist'][1]){            $data['ban_thumb'] = $this->db->getstr("select thumb from ###_category where id={$data['catlist'][1]}","thumb");        }		#条件		$id    = (int) $id;		$where = " WHERE id=$id AND lang=" . LANG_ID;		if ($this->fieldsinfo['status']) {			$where .= " AND status=1 ";		}		#内容详情与所属栏目		$data['row'] = $this->db->get("SELECT * FROM ###_" . $m . $where);		if ($data['row']) {			#更新点击			if ($this->fieldsinfo['hits']) {				$this->db->update($m, 'hits=hits+1', array('id' => $id));			}		} else {showError('访问错误，内容不存在');die;}		#发送变量		$this->smarty->assign('fieldsinfo', $this->fieldsinfo);		$this->smarty->assign('data', $data);		$this->display_before($data['row']);		#显示模板		$template = 'show';		if (isset($data['row']['template']) && !empty($data['row']['template'])) {			$template = $data['row']['template'];		} else if (!empty($data['cat']['template_show'])) {			$template = $data['cat']['template_show'];		}		$tpl = $m . '_' . $template . '.html';		$this->smarty->display($tpl);	}	#检查模型是否存在 and 获取模型和字段配置信息	function chkModule($m) {		$this->content->chkModule($m);		$this->moduleinfo = $this->content->getModuleinfo();		$this->fieldsinfo = $this->content->getFieldsinfo();		$this->smarty->assign('moduleinfo', $this->moduleinfo);	}	#静态页面	function html($name) {		$template = 'html/' . $name . '.html';		if (empty($name) || !$this->smarty->templateExists($template)) {			$this->msg();		}		$row = array();		if ($name == 'winrules') {			$row['title'] = '竞拍中奖规则';		} elseif ($name == 'js') {			$content = $this->smarty->fetch($template);			die($content);		}		$this->ur_here($row['title']);		$this->display_before($row);		$this->smarty->display($template);	}        	//申请入驻1        function  apply(){                        if(!isset($_SESSION['b_id'])){                $this->redirect("/");            }            if(isset($_POST['Submit'])){                                $post = $_POST['post'];                                                                if (empty($post['name']))exit($this->msg('店铺名称不能为空'));                                     if (empty($post['note']))exit($this->msg('店铺描述不能为空'));                                     if (empty($post['truename']))exit($this->msg('真实姓名不能为空'));                                     if (empty($post['card']))exit($this->msg('身份证号码不能为空'));                if (empty($post['qq']))exit($this->msg('QQ不能为空'));                if (empty($post['email']))exit($this->msg('邮箱不能为空'));                $post['zone'] = end(array_filter($_POST['zone']));                if (empty($post['zone']))exit($this->msg('常驻地址不能为空'));                                                                             $this->load->model("upload");                $images_url = $this->load->config('picture','image_url');                if($_FILES['logo']['error']==0){                    $post['logo'] = $this->upload->upload_image('logo', $images_url.'logo/');                }                    if (empty($post['logo']))exit($this->msg('店铺LOGO不能为空'));                                //$post['c_time'] = RUN_TIME;                $res = $this->db->update('business', $post,array("id"=>$post['id']));			                if (false !== $res) {                                       exit($this->msg('',array("url"=>"/content/applytwo")));                } else {                    exit($this->msg('操作失败'));                }                           }            $data['b_info'] = $this->business_info;            $this->smarty->assign("data",$data);            $this->display_before($data);            $this->smarty->display('apply.html');        }                //申请入驻2        function  applytwo(){            $id = $_SESSION['b_id'];            if(!isset($_SESSION['b_id'])){                $this->redirect("/");            }            $data['b_info'] = $this->business_info;                         $this->smarty->assign("data",$data);                        $cash = $this->db->get("select * from ###_business_bankcard where sid=".$id);                   $this->smarty->assign("cash",$cash);            $this->display_before($data);            $this->smarty->display('applytwo.html');        }                //个人提交        function apply_personal(){            if(isset($_POST['Submit'])){                $post = $_POST['post'];                $this->load->model("upload");                $images_url = $this->load->config('picture','image_url');                if($_FILES['idcard']['error']==0){                    $post['card_image'] = $this->upload->upload_image('idcard', $images_url.'idcard/');                }                if (empty($post['card_image']))exit($this->msg('请上传身份证正面'));                                if($_FILES['idcard2']['error']==0){                    $post['card_image2'] = $this->upload->upload_image('idcard2', $images_url.'idcard2/');                }                if (empty($post['card_image2']))exit($this->msg('请上传身份证反面'));                                if($_FILES['idcard3']['error']==0){                    $post['card_image3'] = $this->upload->upload_image('idcard3', $images_url.'idcard3/');                }                if (empty($post['card_image3']))exit($this->msg('请上传手持身份证头部照片'));                                $post['status'] = 0;                $res = $this->db->update("business", $post, array("id"=>$post["id"]));                                //保存提现信息                $cash = $_POST['cash'];                $cash['sid'] = $post["id"];                $cash['c_time'] = RUN_TIME;                $this->db->insert("business_bankcard", $cash);                exit($this->msg('提交成功，等待管理员审核',array("url"=>"/content/applythree")));            }        }        //企业提交        function apply_company(){            if(isset($_POST['Submit'])){                $post = $_POST['post'];                                if (empty($post['license']))exit($this->msg('营业执照注册号不能为空'));                                     if (empty($post['company']))exit($this->msg('公司名称不能为空'));                                     if (empty($post['company_capital']))exit($this->msg('注册资金不能为空'));                                     if (empty($post['company_range']))exit($this->msg('经营范围不能为空'));                                if (empty($post['compay_username']))exit($this->msg('法人姓名不能为空'));                $post['company_zone'] = end(array_filter($_POST['company_zone']));                if (empty($post['company_zone']))exit($this->msg('联系地址不能为空'));                if (empty($post['company_addr']))exit($this->msg('详细地址不能为空'));                if (empty($post['company_mobile']))exit($this->msg('法人手机不能为空'));                if (empty($post['company_tel']))exit($this->msg('法人固话不能为空'));                                                $this->load->model("upload");                $images_url = $this->load->config('picture','image_url');                if($_FILES['license_image']['error']==0){                    $post['license_image'] = $this->upload->upload_image('license_image', $images_url.'other/');                }                   if (empty($post['license_image']))exit($this->msg('请上传营业执照扫描件'));                                if($_FILES['tax_image']['error']==0){                    $post['tax_image'] = $this->upload->upload_image('tax_image', $images_url.'other/');                }                                if (empty($post['tax_image']))exit($this->msg('请上传税务登记证件扫描件'));                                if($_FILES['code_image']['error']==0){                    $post['code_image'] = $this->upload->upload_image('code_image', $images_url.'other/');                }                          if (empty($post['code_image']))exit($this->msg('请上传组织机构代码证扫描件'));                //品牌授权书                if($_FILES['brand_auth']['error']==0){                    $post['brand_auth'] = $this->upload->upload_image('brand_auth', $images_url.'other/');                }                //商标证书                if($_FILES['trademark']['error']==0){                    $post['trademark'] = $this->upload->upload_image('trademark', $images_url.'other/');                }                                if($_FILES['idcard']['error']==0){                    $post['card_image'] = $this->upload->upload_image('idcard', $images_url.'idcard/');                }                if (empty($post['card_image']))exit($this->msg('请上传身份证正面'));                                if($_FILES['idcard2']['error']==0){                    $post['card_image2'] = $this->upload->upload_image('idcard2', $images_url.'idcard2/');                }                if (empty($post['card_image2']))exit($this->msg('请上传身份证反面'));                $post['status'] = 0;                $res = $this->db->update("business", $post, array("id"=>$post["id"]));                                //保存提现信息                $cash = $_POST['cash'];                $cash['sid'] = $post["id"];                $cash['c_time'] = RUN_TIME;                $this->db->insert("business_bankcard", $cash);                exit($this->msg('提交成功，等待管理员审核',array("url"=>"/content/applythree")));            }        }                //申请入驻3 等待审核        function  applythree(){            $id = $_SESSION['b_id'];            if(!isset($_SESSION['b_id'])){                $this->redirect("/");            }            $data['b_info'] = $this->business_info;              $amount = $data['b_info']['type']==1?(C('per_fee')+C('per_deposit')):(C('com_fee')+C('com_deposit'));            if($data['b_info']['status']==1 && $data['b_info']['pay_status']==0 && $amount>0){                if($amount>0){                    $this->applyfour($data['b_info']['id']);                    die;                }else{                    $this->redirect("/business");                }            }            $this->smarty->assign("data",$data);            $this->display_before($data);            $this->smarty->display('applythree.html');        }        //申请入驻4 支付认证费用和保证金        function  applyfour($id){                        if(!isset($_SESSION['b_id'])){                $this->redirect("/");            }                        $data['b_info'] = $this->business_info;            $pay_code = "wxpay";            //招商分离            $zs_url = C('zs_url');            if($zs_url){                $pay_code = "alipay";            }            //生成支付按钮            $this->load->model('payment');            $payment_info = $this->db->get("SELECT * FROM ###_payment WHERE pay_code='wxpay'");            $order = array();            $order['order_amount'] = $data['b_info']['fee']+$data['b_info']['deposit'];            $log_info = $this->db->get("SELECT * FROM ###_pay_log  WHERE order_id = '{$data['b_info']['id']}' and order_type=".PAY_BS);            if($log_info==false){                $order['log_id'] = $this->payment->pay_log_save(array('order_id' => $data['b_info']['id'], 'order_amount' => $order['order_amount'], 'order_type' => PAY_BS, 'is_paid' => PS_UNPAYED));            }else{                $order['log_id'] = $log_info['log_id'];            }            $order['out_trade_no'] = date("YmdHis").'_'.$order['log_id'];            $order['order_sn'] = $order['out_trade_no'];            $this->payment->pay_log_save(array('log_id'=>$order['log_id'],'out_trade_no'=>$order['out_trade_no'],'order_amount' => $order['order_amount'], 'order_type' => PAY_BS, 'is_paid' => PS_UNPAYED));            //取得支付信息，生成支付代码            $payment = unserialize_config($payment_info['pay_config']);            /* 调用相应的支付方式文件 */            include_once AppDir . 'includes/modules/payment/' . $payment_info['pay_code'] . '.php';            /* 取得在线支付方式的支付按钮 */            $pay_obj = new $payment_info['pay_code'];            $payment_info['pay_button'] = $pay_obj->get_code($order, $payment);            $this->smarty->assign('payment_info', $payment_info);            $this->smarty->assign("data",$data);            $this->display_before($data);            $this->smarty->display('applyfour.html');        }}