<?php/** * Name 微信菜单设置 * Class wxmenu */class wxmenu extends Lowxp {    /**     * 微信菜单设置     */    function index() {        $this->load->model('wxapi');        $oauthRedirect = $this->wxapi->wechat->getOauthRedirect(RootUrl, 'zzwxoauth', 'snsapi_userinfo');        $this->smarty->assign('oauthRedirect', $oauthRedirect);        $menuRow = $this->db->get("SELECT * FROM `###_wx_menu_data` WHERE id=1");        $json    = empty($menuRow['json']) ? '{"button":{}}' : $menuRow['json'];        $this->smarty->assign('menusjson', htmlentities($json));        $this->smarty->display('manage/wxmenu/index.html');    }    /**     * 后台修改微信菜单后 在这里做保存     * 每次都做完整的覆盖保存 并且没有错误信息提示     */    function save() {        unset($_POST['ajax']);        $json = json_encode($_POST);        //print_r($_POST);exit;        $data = array(            'json' => $json,        );        $release = '';        foreach($_POST['button'] as $k=>$v){            if($v['sub_button']){                foreach($v['sub_button'] as $_k=>$_v){                    if($_v['key']==null)continue;                    $release[$_v['key']]['type'] = $_v['type'];                    $release[$_v['key']]['key'] = $_v['key'];                    $release[$_v['key']]['data'] = $_v['data'];                }            }else{                if($v['key']==null)continue;                $release[$v['key']]['type'] = $v['type'];                $release[$v['key']]['key'] = $v['key'];                $release[$v['key']]['data'] = $v['data'];            }        }        $data['release'] = json_encode($release);        $row = $this->db->get("SELECT * FROM `###_wx_menu_data` WHERE id=1");        if ($row) {            $this->db->update('###_wx_menu_data', $data, 'id=1');        } else {            $data['id'] = 1;            $this->db->insert('###_wx_menu_data', $data);        }    }    /**     * 提交发布菜单     */    function postMenu() {        $this->load->model('wxapi');        $reslut = $this->wxapi->menuCreate();        if ($reslut) {            $this->tip('提交成功');        } else {            $this->tip('提交失败', array('type' => 1));        }    }    /**     * 获取图文回复 本方法为公用功能 在很多模块均有调用     * 后期优化阶段 建议将本方法合并到公共模块便于理解     * e2-wxmenu-editTab-news 方法     * 具体参考 wxmenu.js 里面的 editTab     */    function getNewsList($page = 1) {        $this->load->model('page');        $_GET['page'] = $page;        $wxnews       = $this->page->query("SELECT * FROM ###_wx_news ")->result_array();        $this->load->model('wxnews');        $wxnews = $this->wxnews->getNewsInfo($wxnews);        $this->smarty->assign('list', $wxnews);        $this->smarty->display('manage/wxmenu/news_list.html');    }}