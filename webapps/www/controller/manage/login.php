<?php/** * ZZCMS 管理员登录 * ============================================================================ * * 版权所有 2014-2016 厦门紫竹数码科技有限公司，并保留所有权利。 * 网站地址: http://www.lnest.com； * ---------------------------------------------------------------------------- * 这不是一个自由软件！您只能在不用于商业目的的前提下对程序代码进行修改和 * 使用；不允许对程序代码以任何形式任何目的的再发布。 */class login extends Lowxp {	function __construct() {		parent::__construct();		$_GET && SafeFilter($_GET);        $_POST && SafeFilter($_POST);        $_COOKIE && SafeFilter($_COOKIE);        $_REQUEST && SafeFilter($_REQUEST);		$this->load->model('user');		if (isset($_SESSION['uid']) && isset($_SERVER['request']['method'])) {			$method = $_SERVER['request']['method'];			if ($method != 'destroy') {				//todo:让用户选择退出登录或跳转到home				$this->exeJs('alert("当前已登录,该操作需在未登录状态下.");');				//跳转到一个初始页面				$this->exeJs('location.href="/manage/login/destroy"');				#$this->exeJs('location.href="/welcome";');				die;			}		}	}	/**	 * 首页	 */	function index() {		$this->smarty->display('manage/login/login.html');	}	/**	 * 显示错误	 * @param $msg	 */	private function showError($msg) {		$this->exeJs('alert("' . $msg . '");');die;	}	/**	 * 登录	 */	function submit() {		$username = $_POST['username'];		$password = $_POST['password'];		$scode    = trim($_POST['scode']);        if(defined('RUNSTOP')){            $this->showError('您的使用期限已到期，请联系官方客服!');        }		if (isset($this->common['verify_admin']) && $this->common['verify_admin']) {			if ($scode != -1 && strtolower($scode) != strtolower($_SESSION['scode'])) {				$this->showError('验证码错误!');			}		}		$user = $this->db->get("SELECT uid,username,password,salt,group_id,visitor FROM ###_m_user WHERE username='" . $username."'");		if (isset($user['uid'])) {			$this->load->model('user');			if ($this->user->get_salt_hash($password, $user['salt']) != $user['password']) {				$this->showError('账号或密码错误!');			}			//执行登录操作			$this->setLogin($user);			#获取第一个链接进行跳转.			$this->exeJs('login.subSucc()');		} else {			$this->showError('账号或密码错误!');		}	}	/**	 * 退出登录	 */	function destroy() {		#$_SESSION = array();		unset($_SESSION['uname']);unset($_SESSION['uid']);unset($_SESSION['gid']);		header('Location:/manage/login');	}	/**	 * 登录初始化session	 * @param $user	 */	private function setLogin($user) {		$_SESSION['uname'] = $user['username'];		$_SESSION['uid']   = $user['uid'];		$_SESSION['gid']   = $user['group_id'];        $_SESSION['vor']  = $user['visitor'];		//默认皮肤.		$_SESSION['skin'] = '1';	}}