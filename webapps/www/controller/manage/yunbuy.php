<?php/** * ZZCMS 挖宝 * ============================================================================ * * 版权所有 2014-2016 厦门紫竹数码科技有限公司，并保留所有权利。 * 网站地址: http://www.lnest.com； * ---------------------------------------------------------------------------- * 这不是一个自由软件！您只能在不用于商业目的的前提下对程序代码进行修改和 * 使用；不允许对程序代码以任何形式任何目的的再发布。 * */class yunbuy extends Lowxp {	function __construct() {		#按钮		$this->btnMenu = array(			0 => array('url' => '#!yunbuy/index', 'name' => '云购管理'),			4 => array('url' => '#!yunbuy/edit?com=xshow|添加云购', 'name' => '添加云购'),		);		parent::__construct();		#加载		$this->load->model('yunbuy');	}	function index($page = 1) {		#检索		$_GET['status'] = isset($_GET['status']) ? $_GET['status'] : 1;		$conds          = $this->getConds();		$condition      = " WHERE buy_id<>0 ";		$condition .= count($conds) ? ' AND ' . implode(' AND ', $conds) : '';		$orderby = " ORDER BY buy_id DESC ";		#分页		$this->load->model('page');		$_GET['page'] = intval($page);		$this->page->set_vars(array('per' => (int) $this->common['page_listrows']));		#数据集		$sql = "SELECT * FROM " . $this->yunbuy->baseTable . $condition . $orderby;		$data['list'] = $this->page->hashQuery($sql)->result_array();		foreach ($data['list'] as $k => $v) {			$v['status']      = $this->yunbuy->status($v);			$v['true_price']  = $this->db->getstr("SELECT price FROM ###_goods WHERE id = $v[goods_id]");			$data['list'][$k] = $v;		}		$this->smarty->assign('data', $data);		$this->smarty->display('manage/yunbuy/list.html');	}	//创建/更新	function edit() {		//提交		if (isset($_POST['Submit'])) {			$res = $this->yunbuy->save();			if (isset($res['code']) && $res['code'] == 0) {				$this->tip($res['message'], array('inIframe' => true));				$this->exeJs("parent.com.xhide();parent.main.refresh()");			} else {				$this->tip($res['message'], array('inIframe' => true, 'type' => 1));			}			exit;		}		$id    = (int) $_GET['id'];		$row   = array();		$goods = array();		//编辑		if ($id) {			$row      = $this->db->get("SELECT * FROM " . $this->yunbuy->baseTable . " WHERE buy_id=" . $id);			$ext_info = unserialize($row['ext_info']);			if (!empty($ext_info)) {				$row = array_merge($row, $ext_info);			}			$this->smarty->assign('id', $id);			$goods = $this->db->get("SELECT * FROM ###_goods WHERE id = " . $row['goods_id']);		} else {			$row = array(				'is_show' => 1,				'type'    => 1,				'posid'   => 0,			);			$goods = array();		}		//商品内容		$goods['html_content'] = $this->form->editor('content', $goods['content'], 'name="post[content]" style="width:670px;height:250px;"', array());		//生成图片控件		$row['html_thumb']       = $this->form->files('thumb', $row['thumb']);		$row['html_goods_thumb'] = $this->form->files('thumbs', $row['thumbs'], '上传图集', array(			'maxnum' => 5,		));		#获取下拉品牌		$this->load->model('brand');		$select_brands = $this->brand->category_option($goods['bid']);		$this->smarty->assign('select_brands', $select_brands);		#云购分类		$this->load->model('yuncat');		$select_yuncategorys = $this->yuncat->category_option($row['cid']);		$this->smarty->assign('select_yuncategorys', $select_yuncategorys);		if (!$id) {			$this->smarty->assign('btnNo', 1);		}		$this->smarty->assign('row', $row);		$this->smarty->assign('goods', $goods);		$this->smarty->display('manage/yunbuy/edit.html');	}	//删除	function del() {		$id = (int) $_POST['id'];		if (!$id) {			die;		}		admin_log('删除一元购商品：' . $this->db->getstr("SELECT title FROM " . $this->yunbuy->baseTable . " WHERE buy_id=" . $id));		$this->db->delete($this->yunbuy->baseTable, array('buy_id' => $id));		$this->tip('删除成功', array('type' => 1));	}	//订单	function order($page = 1) {		$condition = " WHERE d.id<>0 ";		if ($_GET['status']) {			$condition .= " AND d.status = '" . intval($_GET['status']) . "'";		}		if ($_GET['type']) {			$condition .= " AND d.type = '" . intval($_GET['type']) . "'";		}		if ($_GET['k'] == 'order_sn' && $_GET['q']) {			$condition .= " AND o." . trim($_GET['k']) . " LIKE '%" . trim($_GET['q']) . "%'";		} elseif ($_GET['q']) {			$condition .= " AND d." . trim($_GET['k']) . " LIKE '%" . trim($_GET['q']) . "%'";		}		if ($_GET['is_award']) {			$condition .= $_GET['is_award'] == 1 ? " AND d.is_award = '1'" : " AND d.is_award = '0'";		}		if ($_GET['start_time']) {			$condition .= " AND d.add_time >= '" . strtotime($_GET['start_time']) . "'";		}		if ($_GET['end_time']) {			$condition .= " AND d.add_time <= '" . (strtotime($_GET['end_time']) + 3600 * 24) . "'";		}		$this->smarty->assign($_GET);		$orderby = " ORDER BY id DESC ";		#分页		$this->load->model('page');		$_GET['page'] = intval($page);		$this->page->set_vars(array('per' => (int) $this->common['page_listrows']));		#数据集		$sql          = "SELECT d.* FROM ###_yundb AS d LEFT JOIN ###_yunorder AS o ON o.order_id = d.order_id " . $condition . $orderby;		$data['list'] = $this->page->hashQuery($sql)->result_array();		$data['list'] = $this->db->lJoin($data['list'], 'yunbuy', 'buy_id,thumb,thumbs', 'buy_id', 'buy_id');		if ($data['list']) {			foreach ($data['list'] as $k => $v) {				$v                = $this->yunbuy->getThumb($v, 1, array('thumb'));				$data['list'][$k] = $v;			}			$this->load->model('upload');			$data['list'] = $this->upload->getImgUrls($data['list'], 'cover', 'gallery', array('thumb'));		}		$this->smarty->assign('data', $data);		#金额统计		$total           = array();		$total['amount'] = $this->db->getstr("SELECT SUM(d.total) FROM ###_yundb AS d LEFT JOIN ###_yunorder AS o ON o.order_id = d.order_id " . $condition);		$sql = "SELECT SUM(g.price) FROM ###_yundb AS d                    LEFT JOIN ###_yunbuy AS y ON d.buy_id = y.buy_id                    LEFT JOIN ###_yunorder AS o ON d.order_id = o.order_id                    LEFT JOIN ###_goods AS g ON y.goods_id = g.id " . $condition;		$total['price_amount'] = $this->db->getstr($sql);		$this->smarty->assign('total', $total);		$this->smarty->display('manage/yunbuy/order.html');	}	//订单详情	function detail() {		$id              = intval($_GET['id']);		$row             = $this->db->get("SELECT * FROM ###_yundb WHERE id = '$id'");		$row['yun_code'] = explode(",", $row['yun_code']);		#商品图片		if ($row['cover']) {			$picdata = array('id' => $row['cover']);			$this->load->model('upload');			$row['cover'] = $this->upload->getGalleryImgUrls($picdata, array('thumb'));		}		$this->smarty->assign('row', $row);		$this->smarty->display('manage/yunbuy/detail.html');	}	/** 获取过滤条件	 * @return array	 */	function getConds() {		$where = array();		#关键词搜索		$array = array('k', 'q');		foreach ($array as $v) {			if (!isset($_GET[$v])) {				$_GET[$v] = '';			}		}		if (!empty($_GET['q'])) {			$where[] = "`" . trim($_GET['k']) . "` LIKE '%" . addslashes($_GET['q']) . "%'";		}		$array = array('status', 'type', 'posid');		foreach ($array as $v) {			if (!isset($_GET[$v])) {				$_GET[$v] = '';			}		}		if ($_GET['status'] !== '') {			$status_sql = $this->yunbuy->status_sql($_GET['status']);			if ($status_sql) {				$status_arr = explode('AND ', $status_sql);				foreach ($status_arr as $v) {					if (trim($v)) {						$where[] = $v;					}				}			}		}		if ($_GET['posid']) {			if ($_GET['posid'] == 1) {$where[] = " posid=1";} else { $where[] = " posid!=1";}		}		if ($_GET['type'] != '') {			$where[] = " `type`=" . intval($_GET['type']);		}		$this->smarty->assign($_GET);		return $where;	}}