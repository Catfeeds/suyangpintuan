<?php/** * ZZCMS 红包 * ============================================================================ * * 版权所有 2014-2016 厦门紫竹数码科技有限公司，并保留所有权利。 * 网站地址: http://www.lnest.com； * ---------------------------------------------------------------------------- * 这不是一个自由软件！您只能在不用于商业目的的前提下对程序代码进行修改和 * 使用；不允许对程序代码以任何形式任何目的的再发布。 */class bonus extends Lowxp {	function __construct() {		$this->btnMenu = array(			0 => array('url' => '#!bonus/index', 'name' => '红包'),			1 => array('url' => '#!bonus/edit?com=xshow|添加红包', 'name' => '添加红包'),			2 => array('url' => '#!bonus/user_bonus', 'name' => '已发放的红包'),		);		parent::__construct();		$this->load->model('bonus');	}	#列表	function index($page = 1) {		#分页		$this->load->model('page');		$_GET['page'] = intval($page);		$this->page->set_vars(array('per' => (int) $this->common['page_listrows']));		#数据集		$sql = "SELECT * FROM " . $this->bonus->baseTable . " ORDER BY id DESC";		$data['list'] = $this->page->hashQuery($sql)->result_array();		foreach ($data['list'] as $k => $v) {			$v['money_type_title'] = $this->bonus->getMoneyType($v['money_type']);			$v['send_type_title'] = $this->bonus->getSendType($v['send_type']);			$v['use_day_title'] = $this->bonus->getUseDay($v['use_day']);			$data['list'][$k] = $v;		}		/*$this->bonus->send(array(			            'bonus_id' => 1,			            'mid'      => 2,			            'number'   => 5,		*/		$this->smarty->assign('data', $data);		$this->smarty->display('manage/bonus/list.html');	}	//创建/更新	function edit() {		//提交		if (isset($_POST['Submit'])) {			$res = $this->bonus->save();			if (isset($res['code']) && $res['code'] == 0) {				$this->tip($res['message'], array('inIframe' => true));				$this->exeJs("parent.com.xhide();parent.main.refresh()");			} else {				$this->tip($res['message'], array('inIframe' => true, 'type' => 1));			}			exit;		}		$id = isset($_GET['id']) ? $_GET['id'] : 0;		$row = array();		//编辑		if ($id) {			$row = $this->db->get("SELECT * FROM " . $this->bonus->baseTable . " WHERE id=" . $id);		}		if (!$id) {			$this->smarty->assign('btnNo', 1);		}		$this->smarty->assign('row', $row);		$this->smarty->assign('money_types', $this->bonus->getMoneyType());		$this->smarty->assign('send_types', $this->bonus->getSendType());		$this->smarty->assign('use_days', $this->bonus->getUseDay());		$this->smarty->display('manage/bonus/edit.html');	}	#发放券	function send() {		//提交		if (isset($_POST['Submit'])) {			$post = $_POST['post'];			$users = explode("\n", $post['users']);			$this->load->model('member');			foreach ($users as $v) {				$v = trim($v);				if (empty($v)) {					continue;				}				$member_info = $this->db->get("SELECT mid FROM ###_member WHERE username='" . $v . "'");				if ($member_info) {					$this->bonus->send(array(						'bonus_id' => $_POST['id'],						'mid'      => $member_info['mid'],						'number'   => $post['number'],						'desc'     => '管理员手动发放' . ($post['desc'] ? ('：' . $post['desc']) : ''),					));				}			}			admin_log('批量发放红包：' . $post['id']);			$this->tip('发放成功', array('inIframe' => true));			$this->exeJs("parent.com.xhide();parent.main.refresh()");			exit;		}		$id = (int) $_GET['id'];		$row = $this->db->get("SELECT * FROM " . $this->bonus->baseTable . " WHERE id=" . $id);		$this->smarty->assign('row', $row);		$this->smarty->display('manage/bonus/send.html');	}	#列表	function user_bonus($page = 1) {		#检索		$conds = $this->getConds();		$condition = " WHERE 1 ";		$condition .= count($conds) ? " AND " . implode(' AND ', $conds) : '';		$orderby = " ORDER BY id DESC ";		#分页		$this->load->model('page');		$_GET['page'] = intval($page);		$this->page->set_vars(array('per' => (int) $this->common['page_listrows']));		#数据集		$sql = "SELECT DISTINCT b.id,b.*,m.username FROM " . $this->bonus->mbTable . " AS b " .			"LEFT JOIN ###_member AS m ON m.mid=b.mid " .			$condition . $orderby;		$data['list'] = $this->page->hashQuery($sql)->result_array();		$data['list'] = $this->db->lJoin($data['list'], 'bonus', 'id,title', 'bonus_id', 'id', 'b_');		$data['list'] = $this->db->lJoin($data['list'], 'yunorder', 'order_id,order_sn', 'order_id', 'order_id', 'o_');		foreach ($data['list'] as $k => $v) {			$v['money_type_title'] = $this->bonus->getMoneyType($v['money_type']);			if (!empty($v['order_id'])) {				$v['disabled'] = 2; #使用			} elseif (!empty($v['end_time']) && $v['end_time'] < time()) {				$v['disabled'] = 1; #过期			} else {				$v['disabled'] = 0; #未使用			}			$data['list'][$k] = $v;		}		$this->smarty->assign('data', $data);		$this->smarty->assign('btnNo', 2);		$this->smarty->display('manage/bonus/list_user_bonus.html');	}	/** 获取过滤条件	 * @return array	 */	function getConds() {		$where = array();		#关键词搜索		$array = array('k', 'q');		foreach ($array as $v) {			if (!isset($_GET[$v])) {				$_GET[$v] = '';			}		}		if (!empty($_GET['q'])) {			$where[] = trim($_GET['k']) . " LIKE '%" . addslashes($_GET['q']) . "%'";		}		if (isset($_GET['id']) && intval($_GET['id'])) {			$where[] = "b.bonus_id=" . intval($_GET['id']);			$row = $this->db->get("SELECT id,title FROM " . $this->bonus->baseTable . " WHERE id=" . intval($_GET['id']));			$this->btnMenu[2] = array('url' => '#!bonus/user_bonus?id=' . $row['id'], 'name' => '已发放的：' . $row['title']);		}		if (isset($_GET['status']) && intval($_GET['status'])) {			$status = intval($_GET['status']);			if ($status == 1) {				#未使用				$where[] = "b.order_id=0 AND (b.end_time<=0 OR b.end_time>" . time() . ")";			} elseif ($status == 2) {				#已使用				$where[] = "b.order_id>0";			} elseif ($status == 3) {				#已过期				$where[] = "b.order_id=0 AND b.end_time>0 AND b.end_time<=" . time();			}		}		$this->smarty->assign('btnMenu', $this->btnMenu);		$this->smarty->assign($_GET);		return $where;	}	//删除	function del() {		$id = (int) $_POST['id'];		if (!$id) {			die;		}		#必须保留一个		admin_log('删除红包：' . $this->db->getstr("SELECT title FROM " . $this->bonus->baseTable . " WHERE id=" . $id));		$this->db->delete('###_bonus', array('id' => $id));		$this->tip('删除成功', array('type' => 1));	}	//移除发放的红包	function del_user_bonus() {		$id = (int) $_POST['id'];		if (!$id) {			die;		}		admin_log('删除发放的红包：' . $id);		$this->db->delete('###_member_bonus', array('id' => $id));		$this->tip('删除成功', array('type' => 1));	}}