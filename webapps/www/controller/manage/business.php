<?php/** * ZZCMS 商家管理 * ============================================================================ * * 版权所有 2014-2016 厦门紫竹数码科技有限公司，并保留所有权利。 * 网站地址: http://www.lnest.com； * ---------------------------------------------------------------------------- * 这不是一个自由软件！您只能在不用于商业目的的前提下对程序代码进行修改和 * 使用；不允许对程序代码以任何形式任何目的的再发布。 */class business extends Lowxp{    function __construct()    {        #按钮        $this->btnMenu = array(            0 => array('url' => '#!business/index', 'name' => '商家列表'),            1 => array('url' => '#!business/add', 'name' => '商家添加'),            2 => array('url' => '#!business/bill', 'name' => '商家结算'),			3 => array('url' => '#!business/bill_log', 'name' => '结算明细'),            4 => array('url' => '#!business/account', 'name' => '商家保证金记录'),			5 => array('url' => '#!business/withdrawals_log', 'name' => '商家提现申请'),        );        parent::__construct();        #加载    }    /**     * 商家列表     */    function index($page = 1)    {        $where = " where 1=1 ";        $order = " order by id desc ";        $act = isset($_GET['act']) ? trim($_GET['act']) : '';        $id = isset($_GET['id']) ? trim($_GET['id']) : '';        $name = isset($_GET['name']) ? trim($_GET['name']) : '';        $mobile = isset($_GET['mobile']) ? trim($_GET['mobile']) : '';        $status = isset($_GET['status']) ? $_GET['status'] : '-1';        $start_time = isset($_GET['start_time']) ? strtotime($_GET['start_time']) : '';        $end_time = isset($_GET['end_time']) ? strtotime($_GET['end_time']) : '';        if ($id) {            $where .= " and id='{$id}'";        }        if ($name) {            $where .= " and name like '%{$name}%'";        }        if ($mobile) {            $where .= " and mobile='{$mobile}'";        }        if ($status > 0 || $status=='0') {            $where .= " and status='{$status}'";        }        if ($start_time) {            $where .= " and c_time>='{$start_time}'";        }        if ($end_time) {            $where .= " and c_time<='{$end_time}'";        }        #分页        $this->load->model('page');        $_GET['page'] = intval($page);        $this->page->set_vars(array('per' => (int)$this->common['page_listrows']));        $sql = "select * from `###_business` $where $order";        $data['list'] = $this->page->hashQuery($sql)->result_array();        $this->smarty->assign('data', $data);        $this->smarty->display('manage/business/index.html');    }    /**     * 添加商家     */    function add($id = '')    {        if (isset($_POST['Submit'])) {            $post = $_POST['post'];            /*if (empty($post['mid'])){                $this->error_msg('用户MID不能为空');            }else{                $res = $this->db->get("select 1 from ###_member where mid={$post['mid']}");                if($res==false)$this->error_msg('该用户不存在不能为空');            }*/            if (empty($post['name'])) $this->error_msg('店铺名称不能为空');            if (empty($post['card'])) $this->error_msg('身份证号码不能为空');            if (empty($post['mobile'])) $this->error_msg('手机不能为空');            if (empty($post['qq'])) $this->error_msg('QQ不能为空');            if (empty($post['email'])) $this->error_msg('邮箱不能为空');            //if ($post['percentage']==0)$this->error_msg('平台佣金比例不能为空');            if (empty($post['license']) && $post['type'] == 2) $this->error_msg('营业执照注册号不能为空');            if (!empty($_POST['password'])) {                $post['salt'] = substr(uniqid(rand()), -6);                $post['password'] = $this->get_salt_hash($_POST['password'], $post['salt']);            }            $post['zone'] = end(array_filter($post['zone']));            if ($post['type'] == 2) {                $post['company_zone'] = $post['zone'];            }            if ($post['id']) {                $isexit = $this->db->get("select 1 from ###_business where mobile='{$post['mobile']}' and status=1 and id!={$post['id']}");                if ($isexit) $this->error_msg('该手机号码已经存在');            } else {                $isexit = $this->db->get("select 1 from ###_business where mobile='{$post['mobile']}' and status=1");                if ($isexit) $this->error_msg('该手机号码已经存在');            }            $this->load->model("upload");            $images_url = $this->load->config('picture', 'image_url');            if ($_FILES['logo']['error'] == 0) {                $post['logo'] = $this->upload->upload_image('logo', $images_url . 'logo/');            } elseif (empty($post['id'])) {                $this->error_msg('请上传店铺LOGO');            }            if ($_FILES['idcard']['error'] == 0) {                $post['card_image'] = $this->upload->upload_image('idcard', $images_url . 'idcard/');            } elseif (empty($post['id'])) {                $this->error_msg('请上传身份证正面');            }            if ($_FILES['idcard2']['error'] == 0) {                $post['card_image2'] = $this->upload->upload_image('idcard2', $images_url . 'idcard2/');            } elseif (empty($post['id'])) {                $this->error_msg('请上传身份证反面');            }            if ($_FILES['idcard3']['error'] == 0) {                $post['card_image3'] = $this->upload->upload_image('idcard3', $images_url . 'idcard3/');            }            if ($_FILES['license_image']['error'] == 0) {                $post['license_image'] = $this->upload->upload_image('license_image', $images_url . 'other/');            } elseif ($post['type'] == 2 && empty($post['id'])) {                $this->error_msg('请上传营业执照');            }            if ($_FILES['tax_image']['error'] == 0) {                $post['tax_image'] = $this->upload->upload_image('tax_image', $images_url . 'other/');            } elseif ($post['type'] == 2 && empty($post['id'])) {                $this->error_msg('请上传税务登记证');            }            if ($_FILES['code_image']['error'] == 0) {                $post['code_image'] = $this->upload->upload_image('code_image', $images_url . 'other/');            } elseif ($post['type'] == 2 && empty($post['id'])) {                $this->error_msg('请上传组织机构代码证');            }            //品牌授权书            if ($_FILES['brand_auth']['error'] == 0) {                $post['brand_auth'] = $this->upload->upload_image('brand_auth', $images_url . 'other/');            }            //商标证书            if ($_FILES['trademark']['error'] == 0) {                $post['trademark'] = $this->upload->upload_image('trademark', $images_url . 'other/');            }            if ($post['id']) {                $post['u_time'] = RUN_TIME;                $info = $this->db->get("select status,mobile from ###_business where id={$post['id']}");                $res = $this->db->update('business', $post, array("id" => $post['id']));            } else {                $post['c_time'] = RUN_TIME;                $res = $this->db->insert('business', $post);            }            if (false !== $res) {                //入驻成功短信通知                if($post['id']){                    if($post['status']==1 && $info['status']!=$post['status'] && statusTpl('sms_business_succ')){//通过                        $this->load->library('sms');                        $this->sms->sendSmsTpl($info['mobile'], 'sms_business_succ');                    }elseif($post['status']==2 && $info['status']!=$post['status'] && statusTpl('sms_business_fail')){//不通过                        $this->load->library('sms');                        $this->sms->sendSmsTpl($info['mobile'], 'sms_business_fail');                    }                }                $this->tip("操作成功", array('inIframe' => true));                $this->exeJs("parent.com.xhide();parent.main.refresh()");            } else {                $this->error_msg('操作失败');            }            exit;        }        $id = $_REQUEST['id'];        $info = $this->db->get("select * from ###_business where id='{$id}'");        //获取分类        $this->load->model("goodscat");        $select_categorys = $this->goodscat->category_top_option(isset($info['cid']) ? $info['cid'] : 0);        $this->smarty->assign('select_categorys', $select_categorys);        $this->smarty->assign('info', $info);        $this->smarty->display('manage/business/edit.html');    }    function del()    {        $id = intval($_REQUEST['id']);        if ($id == 0) $this->error_msg('ID不能为空');        $res = $this->db->delete("business", array("id" => $id));        if (false !== $res) {            $this->tip("操作成功", array('inIframe' => true));            $this->exeJs("parent.com.xhide();parent.main.refresh()");        } else {            $this->error_msg('操作失败');        }    }    function error_msg($msg)    {        $this->tip($msg, array('inIframe' => true));        exit;    }    /**     * 获取加密的密码     *     * @param $password     * @param $salt     * @param string $gsalt     * @return string     */    public function get_salt_hash($password, $salt, $gsalt = 'scYltK')    {        $passwordmd5 = preg_match('/^\w{32}$/', $password) ? $password : md5($password);        return md5($passwordmd5 . $salt . $gsalt);    }    /**     * 商家结算     */    function bill($page=1)    {        $no = trim($_REQUEST['no']);        $name = trim($_REQUEST['name']);        $state = intval($_REQUEST['state']);        if ($no) {            $option['where'] = " and no={$no} ";        }        if ($name) {            $option['where'] = " and name like '%{$name}%' ";        }        if ($state > 0) {            $option['where'] = " and state={$state} ";        }        $this->load->model("business");        $list = $this->business->get_bill(0, $option,$page);        $this->smarty->assign("state_list", $this->business->state);        $this->smarty->assign("list", $list);        $this->smarty->display('manage/business/bill.html');    }    /**     * 商家账单付款     */    function pay_bill()    {        $this->load->model("business");        if (isset($_POST['Submit'])) {            $res = $this->business->update_bill();            if (false !== $res) {                $this->tip("操作成功", array('inIframe' => true));                $this->exeJs("parent.com.xhide();parent.main.refresh()");            } else {                $this->error_msg('操作失败');            }        }        $no = trim($_REQUEST['no']);        $row = $this->business->get_bill_one($no);        $this->smarty->assign("row", $row);        $this->smarty->display('manage/business/bill_pay.html');    }    /**     * 商家账单详情     */    function detail_bill()    {        $this->load->model("business");        $no = trim($_REQUEST['no']);        $row = $this->business->get_bill_one($no);        $this->smarty->assign("row", $row);        $this->smarty->display('manage/business/bill_detail.html');    }    /**     * 生成上月账单     */    function ajax_bill()    {        $this->load->model("business");        $this->business->create_order_bill();        echo 1;        exit;    }    /**     * 商家保证金记录     */    function account($page = 1)    {        $where = " where 1=1 ";        $order = " order by id desc ";        $id = isset($_GET['id']) ? trim($_GET['id']) : '';        $name = isset($_GET['name']) ? trim($_GET['name']) : '';        $start_time = isset($_GET['start_time']) ? strtotime($_GET['start_time']) : '';        $end_time = isset($_GET['end_time']) ? strtotime($_GET['end_time']) : '';        if ($id) {            $where .= " and id='{$id}'";        }        if ($name) {            $where .= " and name like '%{$name}%'";        }        if ($start_time) {            $where .= " and logtime>='{$start_time}'";        }        if ($end_time) {            $where .= " and logtime<='{$end_time}'";        }        #分页        $this->load->model('page');        $_GET['page'] = intval($page);        $this->page->set_vars(array('per' => (int)$this->common['page_listrows']));        $sql = "select * from `###_business_account` $where $order";        $data['list'] = $this->page->hashQuery($sql)->result_array();		if(!empty($data['list'])){        	$this->load->model('business');        	foreach($data['list'] as $k=>$v){        		$business = $this->business->get($v['bid'],'mobile');        		if(isset($business['mobile'])){        			$data['list'][$k]['mobile'] = $business['mobile'];        		}        	}        }        $this->smarty->assign('data', $data);        $this->smarty->display('manage/business/account.html');    }    /**     * 调整账户金额     */    function change_account($bid = '')    {        //提交        if (isset($_POST['Submit'])) {            $post = $_POST['post'];            $row = $this->db->get("SELECT name FROM ###_business WHERE id=" . intval($post['bid']));            if (empty($row)) {                $res = array('code' => 10001, 'message' => '商家不存在!');            }            $input['deposit'] = $post['addfee_deposit'] * floatval($post['deposit']);            $input['desc'] = trim($post['remark']);            $input['name'] = $row['name'];            $input['bid'] = $post['bid'];            $input['logtime'] = RUN_TIME;            $res = $this->db->insert("business_account", $input);            if ($res > 0) {                $this->db->update("business", "deposit=deposit+" . $input['deposit'], array("id" => $post['bid']));            } else {                $this->db->delete("business_account", array("id" => $res));            }            admin_log('调整商家保证金：' . $row['name']);            #发送中奖短信            /*if (abs($input['user_money']) >= 5000 && $this->common['sms_open'] == 1 && statusTpl('sms_account')) {                $this->smarty->assign('username', $row['username']);                $this->smarty->assign('user_money', $input['user_money']);                $this->load->library('sms');                $ret = $this->sms->sendSmsTpl('18450068888', 'sms_account');            }*/            if ($res > 0) {                $this->tip("操作成功", array('inIframe' => true));                $this->exeJs("parent.com.xhide();parent.main.refresh()");            } else {                $this->tip($res['message'], array('inIframe' => true, 'type' => 1));            }            die;        }        $this->load->model("business");        $row = $this->business->get($bid);        $this->smarty->assign('row', $row);        $this->smarty->display('manage/business/change_account.html');    }		/**     * 结算明细     */        function bill_log($page = '1')    {    	#操作类型    	$this->load->model('member');    	$this->smarty->assign('stages', $this->member->stages());    	$sid = intval((isset($_GET['sid']) ? $_GET['sid'] : 0));    	$where = '';    	$order = ' ORDER BY ';    	if ($sid) {    		$where .= " AND sid = '$sid'";    	}	    if (isset($_GET['stage'])&&$_GET['stage']) {    		$where .= " AND stage = '$_GET[stage]'";    	}    	if (isset($_GET['start_time'])&&$_GET['start_time']) {    		$where .= " AND logtime >= '" . strtotime($_GET['start_time']) . "'";    	}    	if (isset($_GET['end_time'])&&$_GET['end_time']) {    		$where .= " AND logtime <= '" . strtotime($_GET['end_time']) . "'";    	}    	if (isset($_GET['sortorder'])&&$_GET['sortorder']) {		    if ($_GET['points']) {			    $order .= trim($_GET['points']) . " " . $_GET['sortorder'];    		} else {    			$order .= "id " . $_GET['sortorder'];    		}       } else {    		$order .= 'id DESC';       }       #关键词搜索       $array = array('k', 'q');       foreach ($array as $v) {      	if (!isset($_GET[$v])) {    		$_GET[$v] = '';    	}       }       if (!empty($_GET['q'])) {      	 $where .= " AND `" . trim($_GET['k']) . "` LIKE '%" . addslashes($_GET['q']) . "%'";       }       $this->smarty->assign($_GET);       $this->load->model('page');       $_GET['page'] = intval($page);       $this->page->set_vars(array(    	'per' => (int)$this->common['page_listrows'],    	'url' => ' href="#!business/bill_log/{num}?mid=' . $mid . '"',       ));        $list = $this->page->hashQuery("SELECT * FROM ###_business_bills WHERE id <> 0 $where $order")->result_array();    	$this->smarty->assign('list', $list);    	$total = $this->db->get("SELECT SUM(user_money) as user_money FROM ###_business_bills WHERE id <> 0 $where");    	$this->smarty->assign('total', $total);    	$this->smarty->assign('btnNo', 3);    	$this->smarty->display('manage/business/bill_log.html');    }        /**     * 商家提现申请     */    function withdrawals_log($page = '1'){    	$where = "  ";    	$order = ' ORDER BY ';    	    	if(isset($_GET['sid'])&&$_GET['sid']){    		$where .= " AND sid = ".$_GET['sid'];    	}    	if (isset($_GET['start_time'])&&$_GET['start_time']) {    		$where .= " AND logtime >= '" . strtotime($_GET['start_time']) . "'";    	}    	if (isset($_GET['end_time'])&&$_GET['end_time']) {    		$where .= " AND logtime <= '" . strtotime($_GET['end_time']) . "'";    	}    	    	if (isset($_GET['sortorder'])&&$_GET['sortorder']) {    		if ($_GET['points']) {    			$order .= trim($_GET['points']) . " " . $_GET['sortorder'];    		} else {    			$order .= "id " . $_GET['sortorder'];    		}    	} else {    		$order .= 'id DESC';    	}    	#关键词搜索    	$array = array('k', 'q');    	foreach ($array as $v) {	    	if (!isset($_GET[$v])) {	    		$_GET[$v] = '';	    	}    	}    	if (!empty($_GET['q'])) {    		$where .= " AND `" . trim($_GET['k']) . "` LIKE '%" . addslashes($_GET['q']) . "%'";    	}    	$this->smarty->assign($_GET);     	$this->load->model('page');     	$_GET['page'] = intval($page);     	$this->page->set_vars(array(     	'per' => (int)$this->common['page_listrows'],     	'url' => ' href="#!business/withdrawals_log/{num}?"',     	));     	$list = $this->page->hashQuery("SELECT * FROM ###_withdraw_commission_sid WHERE id <> 0 $where $order")->result_array();     	$this->smarty->assign('list', $list);     	$total = $this->db->get("SELECT SUM(amount) as amount, SUM(fee) as fee FROM ###_withdraw_commission_sid WHERE id <> 0 $where");     	$this->smarty->assign('total', $total);     	$this->smarty->assign('btnNo', 5);     	$this->smarty->display('manage/business/withdrawals_log.html');    }        /**     * 佣金提现编辑     */    function withdraw_commission_edit($id = "")    {        $row = $this->db->get("SELECT * FROM ###_withdraw_commission_sid WHERE id = '$id'");        if (isset($_POST['Submit']) && $row['status']==0) {            $status = isset($_POST['status']) ? intval($_POST['status']) : 1;            $res = $this->db->update('withdraw_commission_sid', array('status' => $_POST['status']), array('id' => $id));            //不通过返回            if($res !==false && $_POST['status']==2){                $this->load->model('business');                $log_arr = array();                $log_arr['mid'] = $row['sid'];                $log_arr['username'] = $row['name'];                $log_arr['user_money'] = $row['amount']; //余额                $log_arr['desc'] = '商家提现返回 ' ;                $this->business->accountlog(ACT_DRAWING, $log_arr);            }            $this->tip('操作成功', array('inIframe' => true));            $this->exeJs("parent.com.xhide();parent.main.refresh()");        }        $this->smarty->assign('row', $row);        $this->smarty->display('manage/business/withdraw_commission_edit.html');    }    /**     * 商家定位     */    function geolbs($id=''){        $this->smarty->assign("id",encrypt_en($id));        $this->smarty->display('manage/business/geolbs.html');    }}