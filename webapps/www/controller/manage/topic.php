<?php/** * ZZCMS 专题管理 * ============================================================================ * * 版权所有 2014-2016 厦门紫竹数码科技有限公司，并保留所有权利。 * 网站地址: http://www.lnest.com； * ---------------------------------------------------------------------------- * 这不是一个自由软件！您只能在不用于商业目的的前提下对程序代码进行修改和 * 使用；不允许对程序代码以任何形式任何目的的再发布。 */class topic extends Lowxp{    function __construct()    {        #按钮        $this->btnMenu = array(            //0 => array('url' => '#!topic/index', 'name' => '专题管理'),            //1 => array('url' => '#!topic/edit?com=xshow|添加专题', 'name' => '添加专题'),        );        parent::__construct();        $this->load->model("topic");        $this->load->model("topic_type");    }    /*    * 专题列表    */    function index($type=1,$typeid=0,$page = 1)    {        ${$_REQUEST['k']} = $_REQUEST['q'];        $apply_time = !empty($_GET['apply_time']) ? strtotime($_GET['apply_time']) : 0;        $act_time = !empty($_GET['act_time']) ? strtotime($_GET['act_time']) : 0;        $where = "  AND type=".$type;        if ($id > 0) {            $where .= " AND id=" . $id;        }        if ($name) {            $where .= " AND name like '%".$name."%'";        }        if($_GET['typeid']>0){            $where .= " AND typeid=" . $_GET['typeid'];        }        if ($apply_time > 0) {            $where .= " AND apply_stime<=" . $apply_time." AND apply_etime>=".$apply_time;        }        if ($act_time > 0) {            $where .= " AND start_time<=" . $act_time." AND end_time>=".$act_time;        }        if(!empty($_GET['posid'])){            $where .= " AND  FIND_IN_SET('{$_GET['posid']}',posid) ";        }        $sort = !empty($_GET['sort']) ? trim($_GET['sort']) : 'listorder';        $order = !empty($_GET['sort']) ? trim($_GET['order']) : 'ASC';        $option['page'] = $page;        $option['where'] = $where;        $option['order'] = " ORDER BY $sort $order ";        $option['type'] = $type;        $option['typeid'] = $typeid;        $list = $this->topic->getTopicList($option);        $topictype = $this->topic_type->getTypeList($type);        foreach($list as $k=>$v){            $list[$k]['type_name'] = $topictype[$v['typeid']];            $list[$k]['count'] = $this->db->getstr("select count(1) as num from ###_topic_goods where act_id={$v['id']}","num");        }        $this->smarty->assign('list', $list);        $this->smarty->assign('topictype', $topictype);        if($type==1){            $this->btnMenu = array(                0 => array('url' => '#!topic/index', 'name' => '竞价活动'),                1 => array('url' => '#!topic/edit/'.$type.'?com=xshow|添加竞价活动', 'name' => '添加竞价活动'),            );        }else{            $this->btnMenu = array(                0 => array('url' => '#!topic/index', 'name' => '专题活动'),                1 => array('url' => '#!topic/edit/'.$type.'?com=xshow|添加专题活动', 'name' => '添加专题活动'),            );        }        //显示位置        $posidarray = $this->topic->posidArray;        $this->smarty->assign('posidarray', $posidarray);        $this->smarty->assign('btnMenu', $this->btnMenu);        $this->smarty->assign('type', $type);        $this->smarty->display('manage/topic/list.html');    }    /*    * 编辑专题活动    */    function edit($type = 1)    {        //提交        if (isset($_POST['Submit'])) {            $res = $this->topic->save();            if (isset($res['code']) && $res['code'] == 0) {                $this->tip($res['message'], array('inIframe' => true));                $this->exeJs("parent.com.xhide();parent.main.refresh()");            } else {                $this->tip($res['message'], array('inIframe' => true, 'type' => 1));            }            exit;        }        $id = (int)$_GET['id'];        $row = $this->topic->getTopicOne($id);        //生成图片控件        $row['thumb'] = isset($row['thumb']) ? $row['thumb'] : '';        $row['thumbs'] = isset($row['thumbs']) ? $row['thumbs'] : '';        $row['html_thumb'] = $this->form->files('thumb', $row['thumb']);        $row['html_thumbs'] = $this->form->files('thumbs', $row['thumbs'], '上传图集', array(            'maxnum' => 5,        ));        //显示位置        $posidarray = $this->topic->posidArray;        $this->smarty->assign('posidarray', $posidarray);        $topictype = $this->topic_type->getTypeList($type);        $this->smarty->assign('topictype', $topictype);        $this->smarty->assign('row', $row);        $this->smarty->assign('type', $type);        $this->smarty->display('manage/topic/edit.html');    }    /*    * 删除专题活动    */    function del(){        $id = (int) $_POST['id'];        if (!$id) {            die;        }        $is_res = $this->db->get("select 1 from ###_topic_goods where act_id={$id}");        if($is_res){            $this->tip('该活动已有报名', array('type' => 2));        }else{            $this->db->delete('topic', array('id' => $id));            $this->tip('删除成功', array('type' => 1));        }    }    /*    * 报名专题活动    */    function apply($id){        if (isset($_POST['Submit'])) {            $post = $_POST['post'];            $array    = $this->base->explodeChar($post['goods_id'], "\n");            foreach ($array as $v) {                if (trim($v)) {                    $post['goods_id'] = $v;                    $post['status'] = 1;                    $is_res = $this->db->get("select 1 from ###_goods where id={$post['goods_id']}");                    if(!$is_res)continue;                    $res = $this->topic->apply_save($post);                }            }            if (isset($res['code']) && $res['code'] == 0) {                $this->tip($res['message'], array('inIframe' => true));                $this->exeJs("parent.com.xhide();parent.main.refresh()");            } else {                $this->tip($res['message'], array('inIframe' => true, 'type' => 1));            }            exit;        }        $row = $this->topic->getTopicOne($id);        $this->smarty->assign('row', $row);        if($row['catid']){            $this->load->model("topiccat");            $select_categorys = $this->topiccat->get_option(0,$row['catid']);            $this->smarty->assign('select_categorys', $select_categorys);        }        $topictype = $this->topic_type->getTypeList($row['type']);        $this->smarty->assign('topictype', $topictype);        $this->smarty->display('manage/topic/apply.html');    }    /*    * 审核报名    */    function apply_edit(){        //提交        if (isset($_POST['Submit'])) {            $post = $_POST['post'];            $res = $this->topic->apply_save($post);            if (isset($res['code']) && $res['code'] == 0) {                $this->tip($res['message'], array('inIframe' => true));                $this->exeJs("parent.com.xhide();parent.main.refresh()");            } else {                $this->tip($res['message'], array('inIframe' => true, 'type' => 1));            }            exit;        }        $id = intval($_GET['id']);        $row = $this->topic->getApplyOne($id);        $topictype = $this->topic_type->getTypeList($row['type']);        $this->smarty->assign('topictype', $topictype);        //商品信息        $this->load->model("goods");        $goods = $this->goods->get($row['goods_id']);        $this->smarty->assign('goods', $goods);        //echo "<pre>";print_r($goods);exit;        $topic = $this->topic->getTopicOne($row['act_id']);        $this->smarty->assign('topic', $topic);        if($topic['catid']){            $this->load->model("topiccat");            $select_categorys = $this->topiccat->category_option(isset($row['cid']) ? $row['cid'] : 0,$topic['catid']);            $this->smarty->assign('select_categorys', $select_categorys);        }        $this->smarty->assign('row', $row);        $this->smarty->display('manage/topic/apply_edit.html');    }    /*    * 报名列表    */    function apply_list($act_id=0,$page=1){        ${$_REQUEST['k']} = $_REQUEST['q'];        $start_time = !empty($_GET['start_time']) ? strtotime($_GET['start_time']) : 0;        $end_time = !empty($_GET['end_time']) ? strtotime($_GET['end_time']) : 0;        $where = " 1 ";        if ($act_id > 0) {            $where .= " AND a.act_id=" . $act_id;        }        if ($goods_id > 0) {            $where .= " AND a.goods_id=" . $goods_id;        }        if ($name) {            $where .= " AND g.name like '%{$name}%'";        }        if($typeid>0){            $where .= " AND a.typeid=" .$typeid;        }        if ($start_time > 0) {            $where .= " AND a.c_stime>=" . $start_time;        }        if ($end_time > 0) {            $where .= " AND a.c_stime<=" . $end_time;        }        if($_GET['status']>0 || $_GET['status']=='0'){            $where .= " AND a.status=" . intval($_GET['status']);        }        $order = !empty($_GET['order']) ? trim($_GET['order']) : '';        $sort = !empty($_GET['sort']) ? trim($_GET['sort']) : 'ASC';        $option['act_id'] = $act_id;        if($order){            $orderby = $order." ".$sort;        }else{            $orderby = " a.listorder asc,a.id asc";        }        $this->load->model('page');        $_GET['page'] = intval($page);        $sql = "SELECT a.*,g.name,g.team_price,g.thumb FROM ###_topic_goods as a LEFT JOIN ###_goods as g ON a.goods_id=g.id WHERE {$where} ORDER BY $orderby ";        $list = $this->page->hashQuery($sql,$act_id.'/')->result_array();        $list = $this->db->lJoin($list,"topic","id,name,start_time,end_time,typeid","act_id","id","act_");        $topictype = $this->topic_type->getTypeList();        foreach($list as $k=>$v){            $thumb = json_decode($v['thumb'],true);            $list[$k]['img_src'] = yunurl($thumb[0]['path']);            $list[$k]['type_name'] = $topictype[$v['act_typeid']];        }        $this->smarty->assign('list', $list);        $this->smarty->assign('topictype', $topictype);        $this->smarty->assign('act_id', $act_id);        $this->smarty->assign('btnNo', $type);        $this->smarty->display('manage/topic/apply_list.html');    }    /*    * 删除报名    */    function apply_del(){        $id = $_POST['id'];        if (!$id) {            die;        }        $this->db->query("DELETE FROM ###_topic_goods WHERE id in ($id)");        //$this->db->delete('topic_goods', array('id' => $id));        $this->tip('删除成功', array('type' => 1));    }    /**     * 优惠券编辑界面商品分类zTree列表数据源     * @return json     */    public function goodscat() {        $sql  = "SELECT id, parentid as pId,catname as name FROM ###_topic_cat  WHERE ismenu=1 ORDER BY listorder ASC,id ASC";        $list = $this->db->select($sql);        // 所有分类标签        array_unshift($list, array('id' => 0, 'pId' => 0, 'name' => '可选品类'));        $target = empty($_GET['target']) ? array() : explode(',', $_GET['target']);        if ($target) {            ksort($target);            foreach ($list as $k => $v) {                foreach ($target as $m => $n) {                    if ($v['id'] == $n) {                        $list[$k]['checked'] = true;                        unset($target[$m]);                        break;                    }                }            }        }        $res = array(            'error' => 0,            'data'  => array(                'list' => $list,            ),        );        exit(json_encode($res));    }}