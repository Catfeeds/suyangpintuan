<?php/** * ZZCMS 分销管理 * ============================================================================ * * 版权所有 2014-2016 厦门紫竹数码科技有限公司，并保留所有权利。 * 网站地址: http://www.lnest.com； * ---------------------------------------------------------------------------- * 这不是一个自由软件！您只能在不用于商业目的的前提下对程序代码进行修改和 * 使用；不允许对程序代码以任何形式任何目的的再发布。 */class agent extends Lowxp {	function __construct() {		#按钮		parent::__construct();		#加载		$this->load->model('agent');		$this->load->library('tree');	}	/**	 * 合伙人申请列表	 */	function index($page = 1) {		$where      = " where a.type=1 and a.status=0 ";		$order      = " order by id desc ";		$act        = isset($_GET['act']) ? trim($_GET['act']) : '';		$id         = isset($_GET['id']) ? trim($_GET['id']) : '';		$username   = isset($_GET['username']) ? trim($_GET['username']) : '';		$mobile     = isset($_GET['mobile']) ? trim($_GET['mobile']) : '';		$status     = isset($_GET['status']) ? $_GET['status'] : '-1';		$start_time = isset($_GET['start_time']) ? strtotime($_GET['start_time']) : '';		$end_time   = isset($_GET['end_time']) ? strtotime($_GET['end_time']) : '';		if ($id) {			$where .= " and a.id='{$id}'";		}		if ($username) {			$where .= " and b.username like '%{$username}%'";		}		if ($mobile) {			$where .= " and b.mobile='{$mobile}'";		}		if ($status > 0) {			$where .= " and a.status='{$status}'";		}		if ($start_time) {			$where .= " and a.c_time>='{$start_time}'";		}		if ($end_time) {			$where .= " and a.c_time<='{$end_time}'";		}		#分页		$this->load->model('page');		$_GET['page'] = intval($page);		$this->page->set_vars(array('per' => (int) $this->common['page_listrows']));		$sql          = "select a.*,b.username from `###_member_agent` as a left join `###_member` as b on a.mid=b.mid $where $order";		$data['list'] = $this->page->hashQuery($sql)->result_array();		$this->smarty->assign('data', $data);		if ($act) {			$this->smarty->assign('rget', $_GET);		}		$this->smarty->display('manage/agent/index.html');	}	/**	 * 合伙人列表	 */	function lists($page = 1) {		$where      = " where a.type=1 ";		$order      = " order by  a.status asc,a.id desc ";		$act        = isset($_REQUEST['act']) ? trim($_REQUEST['act']) : '';		$id         = isset($_REQUEST['id']) ? trim($_REQUEST['id']) : '';		$username   = isset($_REQUEST['username']) ? trim($_REQUEST['username']) : '';		$mobile     = isset($_REQUEST['mobile']) ? trim($_REQUEST['mobile']) : '';		$status     = isset($_REQUEST['status']) ? $_REQUEST['status'] : '';		$start_time = isset($_REQUEST['start_time']) ? strtotime($_REQUEST['start_time']) : '';		$end_time   = isset($_REQUEST['end_time']) ? strtotime($_REQUEST['end_time']) : '';		$ids        = isset($_REQUEST['ids']) ? trim($_REQUEST['ids']) : '';		if ($id) {			$where .= " and a.id='{$id}'";		}		if ($username) {			$where .= " and b.username like '%{$username}%'";		}		if ($mobile) {			$where .= " and b.mobile='{$mobile}'";		}		if ($status > 0) {			$where .= " and a.status='{$status}'";		}else{			$where .= " and a.status>0";		}				if ($start_time) {			$where .= " and a.c_time>='{$start_time}'";		}		if ($end_time) {			$where .= " and a.c_time<='{$end_time}'";		}		if ($ids) {			$where .= " and a.id in ({$ids})";		}		#分页		$this->load->model('page');		$_GET['page'] = intval($page);		$this->page->set_vars(array('per' => (int) $this->common['page_listrows']));		$sql = "select a.*,b.username from `###_member_agent` as a left join `###_member` as b on a.mid=b.mid $where $order";		if ($act == 'export') {//导出			$list = $this->db->select($sql);			foreach ($list as $k => $v) {				$list[$k]['c_time'] = date('Y-m-d H:i:s', $v['c_time']);			}			$fields = array('id' => 'ID', 'username' => '用户名', 'mobile' => '手机号码', 'c_time' => '申请时间');			$this->load->model('share');			$this->share->SetExcelHeader('合伙人列表-' . date('Y-m-d-H-i'), '合伙人');			$this->share->SetExcelBody($fields, $list);		} elseif ($act == 'send_redpack') {//发红包			$list = $this->db->select($sql);			$str  = join(",", array_column($list, "mid"));			$this->smarty->assign("num", count($list));			$this->smarty->assign('mids', $str);			$html = $this->smarty->fetch('manage/member/send_redpack.html');			echo $html;exit;		} else {			$data['list'] = $this->page->hashQuery($sql)->result_array();			$this->smarty->assign('data', $data);			if ($act) {				$this->smarty->assign('rget', $_GET);			}			$this->smarty->display('manage/agent/lists.html');		}	}	/**	 * 合伙人等级	 */	function agent_rank() {		$sql  = "select * from ###_member_agent_rank order by listorder desc";		$list = $this->db->select($sql);		$this->smarty->assign("list", $list);		$this->smarty->display('manage/agent/agent_rank.html');	}	/**	 * 添加合伙人等级	 */	function agent_rank_edit() {		if (isset($_POST['Submit'])) {			$data              = array();			$data['name']      = trim($_POST['name']);			$data['listorder'] = intval($_POST['listorder']);			$data['scale']     = $_POST['scale'];			if ($_POST['id']) {				$res = $this->db->update('member_agent_rank', $data, array("id" => $_POST['id']));			} else {				$res = $this->db->insert('member_agent_rank', $data);			}			if (false !== $res) {				$this->tip("操作成功", array('inIframe' => true));				$this->exeJs("parent.com.xhide();parent.main.refresh()");			} else {				$this->tip("操作失败", array('inIframe' => true, 'type' => 1));			}			exit;		}		$id   = $_REQUEST['id'];		$info = $this->db->get("select * from ###_member_agent_rank where id='{$id}'");		$this->smarty->assign('info', $info);		$this->smarty->display('manage/agent/agent_rank_edit.html');	}                /**	 * 删除合伙人等级	 */	function agent_rank_del() {		$id  = $_REQUEST['id'];		$res = $this->db->delete("member_agent_rank", array("id" => $id));		if ($res) {			$this->tip("删除成功", array('inIframe' => true));			$this->exeJs("parent.com.xhide();parent.main.refresh()");		} else {			$this->tip("删除失败", array('inIframe' => true, 'type' => 1));		}	}	/**	 * 区域代理申请列表	 */	function agent_apply($page = 1) {		$this->load->model('linkage');		$where      = " where a.type>1 and a.status=0 ";		$order      = " order by id desc ";		$act        = isset($_GET['act']) ? trim($_GET['act']) : '';		$id         = isset($_GET['id']) ? intval($_GET['id']) : '';		$username   = isset($_GET['username']) ? trim($_GET['username']) : '';		$mobile     = isset($_GET['mobile']) ? trim($_GET['mobile']) : '';		$status     = isset($_GET['status']) ? $_GET['status'] : '-1';		$start_time = isset($_GET['start_time']) ? strtotime($_GET['start_time']) : '';		$end_time   = isset($_GET['end_time']) ? strtotime($_GET['end_time']) : '';		if ($id) {			$where .= " and a.id='{$id}'";		}		if ($username) {			$where .= " and b.username like '%{$username}%'";		}		if ($mobile) {			$where .= " and b.mobile='{$mobile}'";		}		if ($status > 0) {			$where .= " and a.status='{$status}'";		}		if ($start_time) {			$where .= " and a.c_time>='{$start_time}'";		}		if ($end_time) {			$where .= " and a.c_time<='{$end_time}'";		}		#分页		$this->load->model('page');		$_GET['page'] = intval($page);		$this->page->set_vars(array('per' => (int) $this->common['page_listrows']));		$sql          = "select a.*,b.username from `###_member_agent` as a left join `###_member` as b on a.mid=b.mid $where $order";		$data['list'] = $this->page->hashQuery($sql)->result_array();		foreach ($data['list'] as $k => $v) {			$v['area']                = $v['areaid'] ? $this->linkage->pos_linkage($v['areaid'], false) : '';			$data['list'][$k]['area'] = str_replace('>', '', $v['area']);		}		$this->smarty->assign('data', $data);		if ($act) {			$this->smarty->assign('rget', $_GET);		}		$this->smarty->display('manage/agent/agent_apply.html');	}	/**	 * 区域代理列表	 */	function agent_list($page = 1) {		$this->load->model('linkage');		$where      = " where a.type>1 ";		$order      = " order by a.status asc,a.id desc ";		$act        = isset($_REQUEST['act']) ? trim($_REQUEST['act']) : '';		$id         = isset($_REQUEST['id']) ? trim($_REQUEST['id']) : '';		$username   = isset($_REQUEST['username']) ? trim($_REQUEST['username']) : '';		$mobile     = isset($_REQUEST['mobile']) ? trim($_REQUEST['mobile']) : '';		$status     = isset($_REQUEST['status']) ? $_REQUEST['status'] : '';		$start_time = isset($_REQUEST['start_time']) ? strtotime($_REQUEST['start_time']) : '';		$end_time   = isset($_REQUEST['end_time']) ? strtotime($_REQUEST['end_time']) : '';		$ids        = isset($_REQUEST['ids']) ? trim($_REQUEST['ids']) : '';		if ($id) {			$where .= " and a.id='{$id}'";		}		if ($username) {			$where .= " and b.username like '%{$username}%'";		}		if ($mobile) {			$where .= " and b.mobile='{$mobile}'";		}		if ($status > 0) {			$where .= " and a.status='{$status}'";		}else{			$where .= " and a.status>0";		}				if ($start_time) {			$where .= " and a.c_time>='{$start_time}'";		}		if ($end_time) {			$where .= " and a.c_time<='{$end_time}'";		}		if ($ids) {			$where .= " and a.id in ({$ids})";		}		#分页		$this->load->model('page');		$_GET['page'] = intval($page);		$this->page->set_vars(array('per' => (int) $this->common['page_listrows']));		$sql = "select a.*,b.username from `###_member_agent` as a left join `###_member` as b on a.mid=b.mid $where $order";		if ($act == 'export') {//导出			$list = $this->db->select($sql);			foreach ($list as $k => $v) {				$list[$k]['c_time'] = date('Y-m-d H:i:s', $v['c_time']);				$v['area']          = $v['areaid'] ? $this->linkage->pos_linkage($v['areaid'], false) : '';				$list[$k]['area']   = str_replace('>', '', $v['area']);			}			$fields = array('id' => 'ID', 'username' => '用户名', 'mobile' => '手机号码', 'area' => '申请地区', 'c_time' => '申请时间');			$this->load->model('share');			$this->share->SetExcelHeader('区域代理列表-' . date('Y-m-d-H-i'), '区域代理');			$this->share->SetExcelBody($fields, $list);		} elseif ($act == 'send_redpack') {//发红包			$list = $this->db->select($sql);			$str  = join(",", array_column($list, "mid"));			$this->smarty->assign("num", count($list));			$this->smarty->assign('mids', $str);			$html = $this->smarty->fetch('manage/member/send_redpack.html');			echo $html;exit;		} else {			$data['list'] = $this->page->hashQuery($sql)->result_array();			foreach ($data['list'] as $k => $v) {				$v['area']                = $v['areaid'] ? $this->linkage->pos_linkage($v['areaid'], false) : '';				$data['list'][$k]['area'] = str_replace('>', '', $v['area']);			}			$this->smarty->assign('data', $data);			if ($act) {				$this->smarty->assign('rget', $_GET);			}			$this->smarty->display('manage/agent/agent_list.html');		}	}	/**	 * 代理编辑	 */	function agent_edit() {		if (isset($_POST['Submit'])) {			$res = $this->agent->updateStatus();			if (isset($res['code']) && $res['code'] == 0) {				$this->tip($res['message'], array('inIframe' => true));				$this->exeJs("parent.com.xhide();parent.main.refresh()");			} else {				$this->tip($res['message'], array('inIframe' => true, 'type' => 1));			}			exit;		}		$id = $_GET['id'];		if (empty($id)) {			return false;		}		$info = $this->agent->getAgentOne($id);		/*$this->load->model('linkage');		$info['area'] = $info['areaid'] ? $this->linkage->pos_linkage($info['areaid'], false) : '';		$info['area'] = str_replace('>', '', $info['area']);*/		if ($info['type'] == 1) {			$rank = $this->db->select("select * from ###_member_agent_rank order by listorder desc");			$this->smarty->assign('rank', $rank);		}                     		$this->smarty->assign('info', $info);		$this->smarty->display('manage/agent/edit.html');	}	/**	 * 删除分销商等级	 */	function agent_del() {		$id  = $_REQUEST['id'];        $row = $this->db->get("select * from ###_member_agent where id=".$id);		$res = $this->db->delete("member_agent", array("id" => $id));                		if ($res) {                       			$r = $this->db->update('member', array('partner_rank' => '0'), array("mid" => $row['mid']));			if ($row['type'] == 1) {				$this->db->update('member', array("partner_id"=>0), array("partner_id"=>$row['mid']));			}			$this->tip("删除成功", array('inIframe' => true));			$this->exeJs("parent.com.xhide();parent.main.refresh()");		} else {			$this->tip("删除失败", array('inIframe' => true, 'type' => 1));		}	}	/**	 * 分销商等级列表	 */	function comms_rank() {		/*$where = "where 1" ;		$sql   = "select * from `###_member_comms_rank` {$where} order by listorder desc,id desc";		$list  = $this->db->select($sql);		foreach ($list as $k => $v) {			//$list[$k]['comss_array'] = unserialize($v['comss']);			$list[$k]['comss_scale_array'] = unserialize($v['comss_scale']);			$list[$k]['conditions_array']  = unserialize($v['conditions']);		}*/                $list = $this->agent->getCommsRankList();		$this->smarty->assign('list', $list);		$con_array = array("comss" => "佣金总收入满", "order" => "订单总金额满", "agent_order" => "分销商带来的订单总额满", "agent_total" => "发展的分销商数", "agent_num" => "直属下级分销商数量");		$this->smarty->assign('con_array', $con_array);		//echo "<pre>";print_r($list);exit;		//分销商佣金级数				$this->smarty->assign('comss_level', COMSS_LEVEL);		$this->smarty->display('manage/agent/comms_rank.html');	}	/**	 * 添加分销商等级	 */	function comms_rank_edit() {		if (isset($_POST['Submit'])) {			$data              = array();			$data['name']      = trim($_POST['name']);			$data['listorder'] = intval($_POST['listorder']);			$data['con_join']  = $_POST['con_join'];			//$data['comss'] = serialize($_POST['comss']);			$data['comss_scale'] = serialize($_POST['comss_scale']);			$data['conditions']  = serialize($_POST['conditions']);			if ($_POST['id']) {				$res = $this->db->update('member_comms_rank', $data, array("id" => $_POST['id']));			} else {				$res = $this->db->insert('member_comms_rank', $data);			}			if (false !== $res) {				S("CM_COMMS_RANK" , NULL);				$this->tip("操作成功", array('inIframe' => true));				$this->exeJs("parent.com.xhide();parent.main.refresh()");			} else {				$this->tip("操作失败", array('inIframe' => true, 'type' => 1));			}			exit;		}		$id   = intval($_GET['id']);//		$sql  = "select * from `###_member_comms_rank` where id={$id}";//		$info = $this->db->get($sql);//		//$info['comss_array'] = unserialize($info['comss']);//		$info['comss_scale_array'] = unserialize($info['comss_scale']);//		$info['conditions_array']  = unserialize($info['conditions']);                $info = $this->agent->getCommsRankOne($id);		$this->smarty->assign('info', $info);		//分销商佣金级数				$this->smarty->assign('comss_level', COMSS_LEVEL);		$this->smarty->display('manage/agent/comms_rank_add.html');	}	/**	 * 删除分销商等级	 */	function comms_rank_del() {		$id  = $_REQUEST['id'];		$res = $this->db->delete("member_comms_rank", array("id" => $id));		if ($res) {			S("CM_COMMS_RANK" , NULL);			$this->tip("删除成功", array('inIframe' => true));			$this->exeJs("parent.com.xhide();parent.main.refresh()");		} else {			$this->tip("删除失败", array('inIframe' => true, 'type' => 1));		}	}	/**	 * 分销商列表	 */	function distriList($page = 1) {		$this->load->model('linkage');		$where      = " where a.type=2 ";		$order      = " order by id desc ";		$act        = isset($_GET['act']) ? trim($_GET['act']) : '';		$id         = isset($_GET['id']) ? trim($_GET['id']) : '';		$username   = isset($_GET['username']) ? trim($_GET['username']) : '';		$mobile     = isset($_GET['mobile']) ? trim($_GET['mobile']) : '';		$status     = isset($_GET['status']) ? $_GET['status'] : '1';		$start_time = isset($_GET['start_time']) ? strtotime($_GET['start_time']) : '';		$end_time   = isset($_GET['end_time']) ? strtotime($_GET['end_time']) : '';		$ids        = isset($_GET['ids']) ? trim($_GET['ids']) : '';		if ($id) {			$where .= " and a.id='{$id}'";		}		if ($username) {			$where .= " and b.username like '%{$username}%'";		}		if ($mobile) {			$where .= " and b.mobile='{$mobile}'";		}		if ($status > 0) {			$where .= " and a.status='{$status}'";		}		if ($start_time) {			$where .= " and a.c_time>='{$start_time}'";		}		if ($end_time) {			$where .= " and a.c_time<='{$end_time}'";		}		if ($ids) {			$where .= " and a.id in ({$ids})";		}		#分页		$this->load->model('page');		$_GET['page'] = intval($page);		$this->page->set_vars(array('per' => (int) $this->common['page_listrows']));		$sql = "select a.*,b.username,b.mobile from `###_member_agent` as a left join `###_member` as b on a.mid=b.mid $where $order";		if ($act == 'export') {//导出			$list = $this->db->select($sql);			foreach ($list as $k => $v) {				$list[$k]['c_time'] = date('Y-m-d H:i:s', $v['c_time']);				$v['area']          = $v['areaid'] ? $this->linkage->pos_linkage($v['areaid'], false) : '';				$list[$k]['area']   = str_replace('>', '', $v['area']);			}			$fields = array('id' => 'ID', 'username' => '用户名', 'mobile' => '手机号码', 'area' => '申请地区', 'c_time' => '申请时间');			$this->load->model('share');			$this->share->SetExcelHeader('区域代理列表-' . date('Y-m-d-H-i'), '区域代理');			$this->share->SetExcelBody($fields, $list);		} else {			$data['list'] = $this->page->hashQuery($sql)->result_array();			foreach ($data['list'] as $k => $v) {				$v['area']                = $v['areaid'] ? $this->linkage->pos_linkage($v['areaid'], false) : '';				$data['list'][$k]['area'] = str_replace('>', '', $v['area']);			}			$this->smarty->assign('data', $data);			if ($act) {				$this->smarty->assign('rget', $_GET);			}			$this->smarty->display('manage/agent/agent_list.html');		}	}	function test() {		echo "<pre>";		print_r($this->get_usertree(317));exit;	}}