<?php/** * Class bonus_model */class bonus_model extends Lowxp_Model {	public $baseTable = '###_bonus';	public $mbTable   = '###_member_bonus';	#保存管理员信息	function save() {		$post = $_POST['post'];		$id   = $_POST['id'];		#初始化数据		#表单处理		if (empty($post['title'])) {return array('code' => 10001, 'message' => '红包名称不能为空!');}		if ($post['send_type'] == 1) {			$where = $id ? " id!=$id AND " : '';			$row   = $this->db->get("SELECT id FROM " . $this->baseTable . " WHERE " . $where . "send_type=1");			if ($row) {return array('code' => 10001, 'message' => '免费中奖赠送类型的红包已经添加，不可添加多个!');}		}		#保存		$where = $id ? array('id' => (int) $id) : '';		$res   = $this->db->save($this->baseTable, $post, '', $where);		if (empty($res)) {return array('code' => 10002, 'message' => '数据操作失败!');} //未知错误		if ($id) {			admin_log('编辑红包：' . $post['title']);			return array('code' => 0, 'type' => 'update', 'message' => '更新成功');		} else {			admin_log('添加多语言：' . $post['title']);			return array('code' => 0, 'type' => 'insert', 'message' => '添加成功');		}	}	//发放红包入口（针对单个会员）	function send($options) {		//post参数：bonus_id红包ID,number发放数量,mid用户ID		$number    = (!isset($options['number']) || !intval($options['number'])) ? 1 : intval($options['number']);		$bonus_id  = (isset($options['bonus_id'])) ? intval($options['bonus_id']) : 0;		$mid       = (isset($options['mid'])) ? intval($options['mid']) : 0;		$desc      = (isset($options['desc'])) ? $options['desc'] : '';		$money     = (isset($options['money'])) ? intval($options['money']) : 0;		$send_type = 0;		//按红包金额赠送		if ($money > 0) {			$bonus_id = $this->db->getstr("SELECT id FROM " . $this->baseTable . " WHERE money='$money' ORDER BY id LIMIT 1");		}		//自动赠送		elseif (isset($options['send_type']) && $options['send_type'] == 1) {			$bonus_id  = $this->db->getstr("SELECT id FROM " . $this->baseTable . " WHERE send_type=1 LIMIT 1");			$send_type = 1;			$number    = 1;		}		$bonus = $this->db->get("SELECT * FROM " . $this->baseTable . " WHERE id=" . $bonus_id);		if (!$bonus) {return array('code' => 10002, 'message' => '红包不存在!');}		$member = $this->db->get("SELECT * FROM ###_member WHERE mid=" . $mid);		if (!$member) {return array('code' => 10002, 'message' => '会员不存在!');}		if ($number > 0) {			for ($i = 0; $i < $number; $i++) {				$id = $this->db->save($this->mbTable, array(					'bonus_id'   => $bonus_id,					'bonus_sn'   => $this->get_bonus_sn(),					'money'      => $bonus['money'],					'money_type' => $bonus['money_type'],					'mid'        => $mid,					'start_time' => time(),					'end_time'   => ($bonus['use_day'] > 0) ? (time() + $bonus['use_day'] * 3600 * 24) : 0,					'desc'       => $desc,				));				if ($send_type == 1) {return $id;}			}		}		return array('code' => 0, 'message' => '红包生成成功!');	}	/** 获取下单时赠送的红包信息	 * @param $order_price	 */	function getBonusOrder($order_price) {		$sql   = "SELECT * FROM ###_bonus WHERE order_price<=" . $order_price . " AND send_type=1 ORDER BY order_price DESC LIMIT 1";		$bonus = $this->db->get($sql);		return $bonus;	}	/**	 * @param int $mid	 * @param int $type 1获取红包数量 0获取要使用的红包	 */	function getBonusUser($options = array(), $type = 0) {		$now   = time();		$mid   = isset($options['mid']) ? $options['mid'] : 1;		$money = isset($options['money']) ? intval($options['money']) : 1;		$sql_public = "FROM ###_member_bonus WHERE mid='$mid' AND order_id=0 AND start_time<'$now' AND end_time>'$now'";		if ($type == 1) {			$sql   = "SELECT * " . $sql_public;			$list  = $this->db->select($sql);			$array = array('count' => count($list), 'count_dis' => 0, 'money' => 0, 'ids' => '');			if (!empty($list)) {				foreach ($list as $v) {					if ($v['end_time'] < time() + 3600 * 24 * 3) {						$array['count_dis'] += 1;					}					$array['ids'] .= empty($array['ids']) ? $v['id'] : (',' . $v['id']);					$array['money'] += $v['money'];				}			}			return $array;		} else {			$sql   = "SELECT * " . $sql_public . " ORDER BY end_time";			$list  = $this->db->select($sql);			$array = array('money' => 0, 'ids' => '', 'list' => array());			if (!empty($list)) {				foreach ($list as $v) {					if ($money - $array['money'] < $v['money']) {break;}					$array['money'] += $v['money'];					$array['ids'] .= empty($array['ids']) ? $v['id'] : (',' . $v['id']);					$array['list'][] = $v;				}			}			return $array;		}	}	//获取红包赠送类别	function getSendType($type = '') {		$types = array(			0 => '普通类型',			1 => '自动赠送',		);		if ($type !== '') {return $types[$type];} else {return $types;}	}	//获取红包类型	function getMoneyType($type = '') {		$types = array(			0 => '元',		);		if ($type !== '') {return $types[$type];} else {return $types;}	}	//获取红包使用天数	function getUseDay($type = '') {		$types = array(			0   => '永久有效',			1   => '一天',			7   => '一周',			15  => '半个月',			30  => '一个月',			90  => '三个月',			365 => '一年',		);		if ($type !== '') {return $types[$type];} else {return $types;}	}	//生成红包序列号	function get_bonus_sn() {		$sn = date('Ymd') . substr(implode(NULL, array_map('ord', str_split(substr(uniqid(), 7, 13), 1))), -8, 8);		return $sn;	}}