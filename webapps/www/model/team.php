<?php/** * 组团类 * Class mall_model */class team_model extends Lowxp_Model {	/**	 * 根据goods_id 获取组团信息	 * @param $id	 * @return array|mixed	 */	function getTeamList($goods_id,$option=array()) {		if (empty($goods_id)) {			return '';		}		$where = " where a.goods_id='{$goods_id}' ";		$orderby = " order by a.id desc ";		$limit = " limit 0,20 "; 				if($option['where']){			$where .= $option['where'];		}		if($option['status']){			$where .= " and a.status={$option['status']} ";		}		if($option['e_time']){			$where .= " and a.e_time>{$option['e_time']} ";		}						if($option['orderby']){			$orderby = " order by {$option['orderby']}";		}						if($option['limit']){			$limit = " limit 0,{$option['limit']}";		}        $sql = "select a.* from `###_goods_order_common` as a {$where} {$orderby} {$limit}";        $res = $this->db->select($sql);        $res = $this->db->lJoin($res, "member", "mid,username", "mid", "mid");        $res = $this->db->lJoin($res, "member_detail", "mid,nickname", "mid", "mid");		foreach($res as $k=>$v){			$endtime = $v['e_time']- RUN_TIME;            $res[$k]['end_time'] = $endtime>0?$endtime:0;		}				return $res;	}                /**	 * 根据id 获取组团信息	 * @param $id	 * @return array|mixed	 */        public function get($id,$sid='',$option=array()){            $id = intval($id);            $where = " where id = {$id} ";            if($sid)$where.=" and sid={$sid} ";            $data['row'] = $this->db->get("select * from ###_goods_order_common {$where}");            if($data['row']==false)return false;            $endtime = $data['row']['e_time'] - RUN_TIME;            $data['row']['end_time'] = $endtime>0?$endtime:0;            $this->load->model("goods");            $data['goods'] = $this->goods->get($data['row']['goods_id']);            /*$data['list'] = $this->db->select("select a.*,a.mobile as order_mobile,m.mobile,m.username,goi.verify_code_id from ###_goods_order as a left join ###_member as m on a.mid=m.mid LEFT JOIN ###_goods_order_item AS goi ON a.id=goi.order_id where a.common_id={$id} and a.status_common>0 {$option['where']} order by a.id asc");            $data['list'] = $this->db->lJoin($data['list'], "member_detail", "mid,nickname", "mid", "mid");*/            $data['list'] = $this->db->select("select a.*,a.mobile as order_mobile from ###_goods_order as a  where common_id={$id} and status_common>0 {$option['where']} {$option['limit']}");            $data['list'] = $this->db->lJoin($data['list'], "member", "mid,mobile,username", "mid", "mid");            $data['list'] = $this->db->lJoin($data['list'], "member_detail", "mid,nickname", "mid", "mid");            foreach($data['list'] as $k=>$v){                $data['list'][$k]['mobile'] = cut_format($v['mobile'],3,4);                $data['list'][$k]['c_time'] = $v['pay_time']>0?$v['pay_time']:$v['c_time'];            }            return $data;                    }                /**	 * @param $id	 * @return array|mixed	 */        public function getList($option = array()){                                    $where = "where 1 ";            $orderby = "order by ";            $orderby .= !empty($option['orderby'])?$option['orderby']:" id desc";                        if($option['status']){                $where .= " AND status =".$option['status'];            }                        if($option['where']){                $where .= $option['where'];            }                              $this->load->model('page');            $_GET['page'] = $option['page'];            $size         = (int) C('page_size');            $this->page->set_vars(array('per' => $size));                        $sql  = "SELECT * FROM  ###_goods_order_common {$where} {$orderby}";            $data['list'] = $this->page->hashQuery($sql)->result_array();            $data['list'] = $this->db->lJoin($data['list'], "goods", "id,price,team_price,thumb,name,sell,team_num", "goods_id", "id","goods_");            $data['list'] = $this->db->lJoin($data['list'], "member", "mid,username,is_robots", "mid", "mid");            $data['list'] = $this->db->lJoin($data['list'], "member_detail", "mid,nickname", "mid", "mid");            return $data['list'];                                }                	}